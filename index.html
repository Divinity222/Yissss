<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Global Chat â€” Supabase</title>
<link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3ctext y='14' font-size='14'%3e%F0%9F%92%AC%3c/text%3e%3c/svg%3e" />
<style>
:root{
  --bg0:#070a16;--bg1:#0b1025;--bg2:#0f172a;
  --card:rgba(255,255,255,.05);--stroke:rgba(255,255,255,.10);--stroke2:rgba(255,255,255,.16);
  --text:#e5e7eb;--muted:#9aa6bd;--accent:#22d3ee;--warn:#fbbf24;--danger:#fb7185;
  --chip:rgba(255,255,255,.08);--shadow:0 18px 60px rgba(0,0,0,.35);
  --r:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);
  font:15px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
  background:
    radial-gradient(900px 600px at 10% -10%, rgba(34,211,238,.20), transparent 60%),
    radial-gradient(900px 650px at 100% 0%, rgba(139,92,246,.20), transparent 55%),
    radial-gradient(700px 500px at 30% 110%, rgba(52,211,153,.10), transparent 60%),
    linear-gradient(180deg,var(--bg0),var(--bg2));
  display:flex;
}
.container{max-width:1320px;margin:0 auto;flex:1;display:flex;flex-direction:column;gap:12px;padding:14px;min-height:0}
.glass{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);box-shadow:var(--shadow);backdrop-filter:blur(10px)}
.row{display:flex;gap:10px;align-items:center}
.grow{flex:1}
.badge{font-size:12px;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--stroke);color:#dbe6ff}
.pill{font-size:12px;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.20);border:1px solid var(--stroke);color:#dbe6ff}
.small{font-size:12px;color:var(--muted)}
.sep{height:1px;background:rgba(255,255,255,.10);margin:10px 0}

input,textarea,select{
  background:rgba(10,16,38,.85);color:var(--text);
  border:1px solid var(--stroke2);border-radius:14px;
  padding:10px 12px;outline:none
}
input:focus,textarea:focus,select:focus{
  border-color:rgba(34,211,238,.55);
  box-shadow:0 0 0 4px rgba(34,211,238,.12)
}
.btn{
  cursor:pointer;border:0;border-radius:14px;padding:10px 12px;
  background:linear-gradient(180deg, rgba(34,211,238,1), rgba(34,211,238,.75));
  color:#001018;font-weight:900;letter-spacing:.2px;
  box-shadow:0 10px 28px rgba(34,211,238,.18)
}
.btn:hover{filter:brightness(1.05)}
.btn.warn{background:linear-gradient(180deg,#fde68a,#fbbf24);color:#241a02;box-shadow:0 10px 28px rgba(251,191,36,.14)}
.btn.danger{background:linear-gradient(180deg,#fb7185,#f43f5e);color:#26060c;box-shadow:0 10px 28px rgba(244,63,94,.18)}
.btn:disabled{opacity:.55;cursor:not-allowed}

header{display:flex;gap:10px;align-items:center}
header h1{margin:0;font-size:18px;letter-spacing:.2px}
#status{font-size:12px;color:var(--muted)}

#roomBar{padding:10px 12px;flex-wrap:wrap}
#roomBar input{flex:1;min-width:140px}
#roomsCard{padding:10px 12px}
#roomsList{display:flex;flex-wrap:wrap;gap:8px}
.roomPill{
  padding:7px 11px;border-radius:999px;background:rgba(10,16,38,.75);
  border:1px solid var(--stroke);font-size:12px;cursor:pointer
}
.roomPill:hover{border-color:rgba(34,211,238,.45);transform:translateY(-1px)}

.layout{
  display:grid;
  grid-template-columns:280px 1fr 360px;
  gap:12px;
  flex:1;
  min-height:0;
}
@media (max-width:1100px){.layout{grid-template-columns:1fr}}
.panel{min-height:0}

#rules{padding:12px;min-height:0}
#rules h3{margin:0 0 8px;font-size:13px;letter-spacing:.2px}
#rules ol{margin:0;padding-left:18px;color:#cbd5e1;line-height:1.35}

#chat{
  display:flex;
  flex-direction:column;
  min-height:0;
  overflow:hidden;
}
#announce{
  display:none;margin:12px 12px 0;padding:12px;border-radius:14px;
  border:1px solid rgba(251,191,36,.55);
  background:linear-gradient(90deg, rgba(251,191,36,.16), rgba(251,191,36,.06));
}
#announce .label{display:inline-block;font-weight:1000;font-size:12px;letter-spacing:.08em;text-transform:uppercase;
  background:var(--warn);color:#1a1205;border-radius:999px;padding:3px 8px;margin-bottom:6px}
#messages{
  flex:1;
  min-height:0;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.sys{text-align:center;font-size:12px;color:var(--muted);margin:8px 0}

.msg{
  padding:10px 12px;border-radius:16px;
  background:linear-gradient(180deg, rgba(10,16,38,.85), rgba(10,16,38,.65));
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 10px 26px rgba(0,0,0,.20);
  display:flex;flex-direction:column;gap:6px
}
.msg:hover{border-color:rgba(255,255,255,.18)}
.msg.me{border-color:rgba(34,211,238,.22)}
.meta{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
.meta strong{color:#dbe6ff}
.msg.me .meta strong{color:#b9f6e0}
.text{white-space:pre-wrap;word-wrap:anywhere;line-height:1.45}
.reactions{display:flex;gap:6px;flex-wrap:wrap;margin-top:2px}
.rxn{
  user-select:none;cursor:pointer;
  display:inline-flex;align-items:center;gap:6px;
  padding:2px 9px;border-radius:999px;
  background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
  font-size:13px
}
.rxn.mine{outline:1px solid var(--accent)}

#composer{
  position:sticky;bottom:0;z-index:3;
  padding:10px 12px;
  background:linear-gradient(180deg, rgba(7,10,22,.00), rgba(7,10,22,.85));
  border-top:1px solid rgba(255,255,255,.10);
  backdrop-filter:blur(10px);
  display:flex;gap:8px;align-items:flex-end
}
#name{width:170px}
#input{flex:1;min-height:44px;max-height:160px;resize:vertical}

.stack{display:flex;flex-direction:column;gap:10px;min-height:0}

@media (max-width:1100px){
  #chat{order:0;min-height:60vh}
  #rules{order:1}
  .rightCol{order:2}
}
@media (max-width:520px){
  #composer{flex-direction:column;align-items:stretch}
  #name{width:100%}
}

.blocker{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;place-items:center;z-index:9999}
.blocker-inner{max-width:520px;text-align:center;padding:24px;border-radius:18px;background:rgba(10,16,38,.92);border:1px solid rgba(255,255,255,.14)}

/* Color swatches */
#colorRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.swatch{width:22px;height:22px;border-radius:999px;border:2px solid rgba(255,255,255,.22);cursor:pointer;box-shadow:inset 0 0 0 1px rgba(0,0,0,.15)}
.swatch.sel{outline:2px solid #fff}

/* Holiday themes (simple) */
body[class*="holiday-"]{transition:background .6s ease, filter .6s ease}
body.holiday-christmas{--accent:#22c55e;--warn:#fb7185;background:linear-gradient(180deg,#022c22,#020617)}
body.holiday-halloween{--accent:#f97316;--warn:#f97316;background:linear-gradient(180deg,#020617,#111827,#4c1d95);filter:saturate(1.1)}
body.holiday-thanksgiving{--accent:#f59e0b;--warn:#fb923c;background:linear-gradient(180deg,#451a03,#7c2d12,#111827)}
body.holiday-easter{--accent:#a855f7;--warn:#fb7185;background:linear-gradient(180deg,#0f172a,#581c87);filter:saturate(1.2)}
body.holiday-valentines{--accent:#ec4899;--warn:#fb7185;background:linear-gradient(180deg,#4a044e,#1f2937);filter:saturate(1.2)}
</style>
</head>

<body>
<div id="blocker" class="blocker">
  <div class="blocker-inner">
    <h2 style="margin:0 0 10px">You've been kicked</h2>
    <p class="small" style="margin:0">An admin removed you from the room. Refresh the page to rejoin.</p>
  </div>
</div>

<div class="container">
  <header class="glass" style="padding:12px">
    <div class="row" style="width:100%">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M21 15a4 4 0 01-4 4H7l-4 4V7a4 4 0 014-4h10a4 4 0 014 4v8z" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <h1>Global Chat</h1>
      <span class="badge" id="online">â€¦</span>
      <span class="badge" id="globalOnline">â€¦</span>
      <div class="grow"></div>
      <span id="status">Connectingâ€¦</span>
    </div>
  </header>

  <div id="roomBar" class="glass row">
    <span class="small">Room</span>
    <input id="roomInput" placeholder="global" />
    <button id="switchRoom" class="btn">Join</button>

    <label class="pill row" style="gap:8px;margin-left:auto;cursor:pointer">
      <input id="notifToggle" type="checkbox" style="width:16px;height:16px;accent-color:var(--accent)" />
      <span class="small" style="color:#dbe6ff">Notify this room</span>
    </label>
    <label class="pill row" style="gap:8px;cursor:pointer">
      <input id="joinToggle" type="checkbox" style="width:16px;height:16px;accent-color:var(--accent)" />
      <span class="small" style="color:#dbe6ff">Notify joins</span>
    </label>
  </div>

  <div id="roomsCard" class="glass">
    <div class="row" style="padding:10px 12px">
      <div class="small">Open rooms</div>
      <div class="grow"></div>
      <div class="small" id="roomsUpdated"></div>
    </div>
    <div id="roomsList" style="padding:0 12px 12px"></div>
  </div>

  <div class="layout">
    <aside class="glass panel" id="rules">
      <h3>Rules</h3>
      <ol>
        <li>No offensive and/or unsafe topics/names</li>
        <li>Slurs/offensive nicknames will be filtered/removed.</li>
        <li>Abusing admin is a removable offense.</li>
        <li>Drama ends quickly or take it private.</li>
        <li>Venting only in Vent rooms or keep it brief.</li>
      </ol>
    </aside>

    <section class="glass panel" id="chat">
      <div id="announce">
        <div class="label">ðŸ“¢ Announcement</div>
        <div id="announceText"></div>
        <div class="small" style="margin-top:6px">â€” <span id="announceBy"></span> <span id="announceAt"></span></div>
      </div>
      <div id="messages"></div>
      <div id="composer">
        <input id="name" placeholder="Nickname" maxlength="20" />
        <textarea id="input" placeholder="Type a messageâ€¦ (Shift+Enter = newline)" maxlength="300"></textarea>
        <button id="send" class="btn">Send</button>
      </div>
    </section>

    <aside class="panel stack rightCol">
      <div class="glass" style="padding:12px">
        <div class="row" style="justify-content:space-between">
          <strong style="font-size:13px">Style</strong>
          <span class="pill">Text color</span>
        </div>
        <div id="colorRow" style="margin-top:10px"></div>
        <div class="small" style="margin-top:8px">Pick a color for your messages.</div>
      </div>

      <div class="glass" style="padding:12px">
        <div class="row" style="justify-content:space-between">
          <strong style="font-size:13px">Admin</strong>
          <span class="pill">Status: <strong id="pauseState">active</strong></span>
        </div>

        <div id="adminLocked" class="stack" style="margin-top:10px">
          <div class="small">Enter passcode to unlock controls.</div>
          <input id="pass" type="password" placeholder="Passcode" />
          <button id="unlock" class="btn">Unlock</button>
        </div>

        <div id="adminControls" class="stack" style="display:none;margin-top:10px">
          <div class="small">Scoped to <strong id="roomNameLabel">global</strong></div>

          <div class="row" style="flex-wrap:wrap">
            <button id="pauseBtn" class="btn warn">Pause</button>
            <button id="unpauseBtn" class="btn">Unpause</button>
            <button id="clearBtn" class="btn danger">Clear</button>
          </div>

          <div class="sep"></div>

          <input id="targetNick" type="text" placeholder="Nickname (case-insensitive)" />
          <div class="row" style="flex-wrap:wrap">
            <button id="kickBtn" class="btn danger">Kick</button>
            <button id="muteBtn" class="btn warn">Mute</button>
            <button id="unmuteBtn" class="btn">Unmute</button>
          </div>
          <div id="muteList" class="small"></div>

          <div class="sep"></div>

          <input id="announceInput" type="text" placeholder="Announcement text" />
          <div class="row" style="flex-wrap:wrap">
            <button id="setAnnBtn" class="btn">Set announcement</button>
            <button id="clrAnnBtn" class="btn danger">Clear</button>
          </div>

          <div class="sep"></div>

          <input id="banTerm" type="text" placeholder="Add banned term" />
          <div class="row" style="flex-wrap:wrap">
            <button id="addBan" class="btn warn">Add term</button>
            <button id="delBan" class="btn">Remove term</button>
          </div>
          <div id="banList" class="small"></div>

          <div class="sep"></div>

          <div class="stack">
            <div class="row">
              <div class="small">Festive theme</div>
              <span class="pill">Active: <strong id="holidayActive">off</strong></span>
            </div>
            <select id="holidaySelect"></select>
            <div class="row" style="flex-wrap:wrap">
              <button id="holidayApply" class="btn">Apply</button>
              <button id="holidayClear" class="btn warn">Clear</button>
            </div>
          </div>

          <div id="ownerOnly" class="stack" style="display:none;margin-top:10px">
            <div class="sep"></div>
            <div class="small"><strong>Owner tools</strong></div>
            <input id="banNick" type="text" placeholder="Ban by nickname (online preferred)" />
            <div class="row" style="flex-wrap:wrap">
              <button id="banBtn" class="btn danger">Ban</button>
              <button id="unbanBtn" class="btn">Unban</button>
            </div>
            <div id="bannedList" class="small"></div>
          </div>
        </div>
      </div>

      <div class="glass" style="padding:12px;min-height:0">
        <div class="row" style="justify-content:space-between">
          <strong style="font-size:13px">Pinned</strong><span class="small">max 5</span>
        </div>
        <div class="small" style="margin:6px 0 10px">Double-click a message to pin. Double-click a pin to unpin.</div>
        <div id="pinList" class="stack" style="max-height:260px;overflow:auto;min-height:0"></div>
      </div>
    </aside>
  </div>

  <div class="small" style="text-align:center;padding:6px 0 0">
    Realtime chat powered by Supabase. Keep it friendly âœ¨
  </div>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

/* ===== Config ===== */
const SUPABASE_URL='https://prpjfrqfbbsxqhspqheo.supabase.co'
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBycGpmcnFmYmJzeHFoc3BxaGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNjgwMDksImV4cCI6MjA3Mzc0NDAwOX0.XEUz5g-tzW4UAsKLk62FJratwaLYAL-1noBTu0EwTkY'

const PERSIST=true, MAX_MSGS=25
const ADMIN_PASS='DivinePermissions'
const OWNER_PASS='ServerHostPanel'
const REACTIONS=['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ˜¡']
const COLORS=[
  '#ffffff','#cbd5e1','#facc15','#fb923c','#22d3ee','#38bdf8','#3b82f6','#8b5cf6',
  '#a78bfa','#ec4899','#f472b6','#f43f5e','#10b981','#a3e635','#f59e0b'
]
const HOLIDAYS={
  none:{label:'Off',emoji:'â¹ï¸'},
  christmas:{label:'Christmas',emoji:'ðŸŽ„'},
  halloween:{label:'Halloween',emoji:'ðŸŽƒ'},
  thanksgiving:{label:'Thanksgiving',emoji:'ðŸ¦ƒ'},
  easter:{label:'Easter',emoji:'ðŸ£'},
  valentines:{label:"Valentine's Day",emoji:'ðŸ’˜'}
}

/* ===== Helpers ===== */
const $=(q,r=document)=>r.querySelector(q)
const $$=(q,r=document)=>[...r.querySelectorAll(q)]
const norm=s=>(s||'').trim().toLowerCase()
const esc=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))
const nowIso=()=>new Date().toISOString()
const msgKey=m=>`${m.user_id}|${m.created_at}|${m.text}`

/* ===== Elements ===== */
const E={
  status:$('#status'), online:$('#online'), globalOnline:$('#globalOnline'),
  roomInput:$('#roomInput'), switchRoom:$('#switchRoom'), roomNameLabel:$('#roomNameLabel'),
  roomsList:$('#roomsList'), roomsUpdated:$('#roomsUpdated'),
  messages:$('#messages'), name:$('#name'), input:$('#input'), send:$('#send'),
  blocker:$('#blocker'),
  announce:$('#announce'), announceText:$('#announceText'), announceBy:$('#announceBy'), announceAt:$('#announceAt'),
  adminLocked:$('#adminLocked'), adminControls:$('#adminControls'), pass:$('#pass'), unlock:$('#unlock'),
  pauseState:$('#pauseState'),
  pauseBtn:$('#pauseBtn'), unpauseBtn:$('#unpauseBtn'), clearBtn:$('#clearBtn'),
  targetNick:$('#targetNick'), kickBtn:$('#kickBtn'), muteBtn:$('#muteBtn'), unmuteBtn:$('#unmuteBtn'),
  muteList:$('#muteList'),
  announceInput:$('#announceInput'), setAnnBtn:$('#setAnnBtn'), clrAnnBtn:$('#clrAnnBtn'),
  banTerm:$('#banTerm'), addBan:$('#addBan'), delBan:$('#delBan'), banList:$('#banList'),
  ownerOnly:$('#ownerOnly'), banNick:$('#banNick'), banBtn:$('#banBtn'), unbanBtn:$('#unbanBtn'), bannedList:$('#bannedList'),
  holidaySelect:$('#holidaySelect'), holidayApply:$('#holidayApply'), holidayClear:$('#holidayClear'), holidayActive:$('#holidayActive'),
  pinList:$('#pinList'),
  notifToggle:$('#notifToggle'), joinToggle:$('#joinToggle'),
  colorRow:$('#colorRow')
}

const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY)

/* ===== State ===== */
const S={
  room:localStorage.getItem('room')||'global',
  name:localStorage.getItem('nickname')||'',
  userId:localStorage.getItem('uid')||crypto.randomUUID(),
  role:'guest', admin:false,
  roomChannel:null, presenceTimer:null, lastNotifyAt:0,
  paused:false, pausedBy:null, pausedName:null,
  muted:new Set(), bannedTerms:new Set(),
  kicked:false, banned:false,
  pins:[], reactions:new Map(),
  holiday:localStorage.getItem('holiday')||'none',
  color:localStorage.getItem('color')||COLORS[0],
  notifyRooms:new Set(JSON.parse(localStorage.getItem('notifyRooms')||'[]')),
  notifyJoinsRooms:new Set(JSON.parse(localStorage.getItem('notifyJoinsRooms')||'[]')),
  lastPresenceCount:0
}
const rendered=new Set()

/* ===== UI helpers ===== */
function setStatus(t){E.status.textContent=t}
function sys(t){
  const d=document.createElement('div')
  d.className='sys'; d.textContent=t
  E.messages.appendChild(d); E.messages.scrollTop=E.messages.scrollHeight
}
function showBlocker(){S.kicked=true;E.blocker.style.display='grid';updateComposerDisabled()}
function clearUI(){E.messages.innerHTML='';rendered.clear()}
function trimUI(){
  const nodes=$$('.msg',E.messages)
  for(let i=0;i<nodes.length-MAX_MSGS;i++) nodes[i].remove()
  E.messages.scrollTop=E.messages.scrollHeight
}
function renderAnnouncement(text,by,at){
  if(!text){E.announce.style.display='none';E.announceText.textContent='';E.announceBy.textContent='';E.announceAt.textContent='';return}
  E.announce.style.display='block'
  E.announceText.textContent=text
  E.announceBy.textContent=by||'admin'
  E.announceAt.textContent=at?new Date(at).toLocaleString():''
}
function setRole(role){
  S.role=role; S.admin=(role==='admin'||role==='owner')
  E.adminLocked.style.display=S.admin?'none':''
  E.adminControls.style.display=S.admin?'block':'none'
  E.ownerOnly.style.display=(role==='owner')?'block':'none'
}
function setPaused(paused,by=null,name=null){
  S.paused=!!paused; S.pausedBy=by; S.pausedName=name
  E.pauseState.textContent=S.paused?(S.pausedName?`paused by ${S.pausedName}`:'paused'):'active'
  updateComposerDisabled()
}
function updateComposerDisabled(){
  const blocked=(S.paused&&S.userId!==S.pausedBy)||S.kicked||S.banned||(S.muted.has(norm(S.name))&&!S.admin)
  E.input.disabled=blocked; E.send.disabled=blocked
  if(S.kicked) E.input.placeholder='You were kicked. Refresh to rejoin.'
  else if(S.banned) E.input.placeholder='You are banned.'
  else if(S.muted.has(norm(S.name))&&!S.admin) E.input.placeholder='You are muted.'
  else if(S.paused&&S.userId!==S.pausedBy) E.input.placeholder='Chat is paused.'
  else E.input.placeholder='Type a messageâ€¦ (Shift+Enter = newline)'
}

/* ===== Colors ===== */
function renderSwatches(){
  E.colorRow.innerHTML=''
  COLORS.forEach(c=>{
    const d=document.createElement('div')
    d.className='swatch'+(S.color===c?' sel':'')
    d.style.background=c
    d.title=c
    d.onclick=()=>{
      S.color=c
      localStorage.setItem('color',c)
      renderSwatches()
    }
    E.colorRow.appendChild(d)
  })
}

/* ===== Moderation ===== */
const collapseRepeats=t=>{let o='',p='',c=0;for(const ch of t){if(ch===p){c++;if(c<=2)o+=ch}else{p=ch;c=1;o+=ch}}return o}
const modNorm=s=>{
  if(!s) return ''
  let t=s.toLowerCase()
  t=t.replace(/[@]/g,'a').replace(/[0]/g,'o').replace(/[1l!]/g,'i').replace(/[3]/g,'e').replace(/[4]/g,'a').replace(/[5$]/g,'s').replace(/[7]/g,'t')
  t=t.replace(/[^a-z0-9]+/g,'')
  return collapseRepeats(t)
}
const violates=text=>{
  const n=modNorm(text)
  for(const term of S.bannedTerms) if(n.includes(term)) return true
  return false
}
const mask=text=>violates(text)?'ðŸš« [filtered]':text

/* ===== Notifications ===== */
async function ensureNotifPermission(){
  if(!('Notification' in window)) return false
  if(Notification.permission==='granted') return true
  if(Notification.permission==='denied') return false
  const p=await Notification.requestPermission()
  return p==='granted'
}
function notify(title, body){
  const now=Date.now()
  if(now - S.lastNotifyAt < 1200) return
  S.lastNotifyAt=now
  try{
    const n=new Notification(title,{body,tag:'room-'+S.room})
    n.onclick=()=>{window.focus(); n.close()}
  }catch{}
}
function saveNotifySets(){
  localStorage.setItem('notifyRooms', JSON.stringify([...S.notifyRooms]))
  localStorage.setItem('notifyJoinsRooms', JSON.stringify([...S.notifyJoinsRooms]))
}
function syncNotifToggles(){
  E.notifToggle.checked=S.notifyRooms.has(S.room)
  E.joinToggle.checked=S.notifyJoinsRooms.has(S.room)
}

/* ===== Reactions ===== */
function renderReactions(id){
  const wrap=$(`.msg[data-id="${CSS.escape(id)}"]`,E.messages)
  if(!wrap) return
  const map=S.reactions.get(id)||{}
  $$('.rxn',wrap).forEach(node=>{
    const emo=node.dataset.emoji
    const set=map[emo]||new Set()
    node.textContent=`${emo}${set.size?` ${set.size}`:''}`
    node.classList.toggle('mine', set.has(S.userId))
  })
}
async function toggleReaction(messageId, emoji){
  const map=S.reactions.get(messageId)||{}
  map[emoji]=map[emoji]||new Set()
  const has=map[emoji].has(S.userId)

  if(has){
    map[emoji].delete(S.userId)
    S.reactions.set(messageId,map); renderReactions(messageId)
    await supabase.from('message_reactions').delete().match({room:S.room,message_id:messageId,emoji,user_id:S.userId})
    S.roomChannel?.send({type:'broadcast',event:'rxn',payload:{op:'del',message_id:messageId,emoji,user_id:S.userId}})
  }else{
    map[emoji].add(S.userId)
    S.reactions.set(messageId,map); renderReactions(messageId)
    await supabase.from('message_reactions').insert({room:S.room,message_id:messageId,emoji,user_id:S.userId})
    S.roomChannel?.send({type:'broadcast',event:'rxn',payload:{op:'add',message_id:messageId,emoji,user_id:S.userId}})
  }
}

/* ===== Messages ===== */
function renderMsg(m){
  const id=msgKey(m), mine=m.user_id===S.userId
  const color = m.color || ''
  const wrap=document.createElement('div')
  wrap.className='msg'+(mine?' me':'')
  wrap.dataset.id=id
  wrap.innerHTML=`
    <div class="meta"><strong>${esc(m.name||'anon')}</strong> Â· ${new Date(m.created_at||Date.now()).toLocaleString()}${mine?' Â· you':''}</div>
    <div class="text" style="color:${esc(color)}">${esc(mask(m.text))}</div>
    <div class="reactions">${REACTIONS.map(e=>`<span class="rxn" data-emoji="${esc(e)}">${esc(e)}</span>`).join('')}</div>
  `
  E.messages.appendChild(wrap)
  renderReactions(id)
}
function addIfNew(m){
  const k=msgKey(m); if(rendered.has(k)) return
  rendered.add(k); renderMsg(m); trimUI()
}

/* Delegated clicks (reactions + pinning) */
E.messages.addEventListener('click', e=>{
  const rxn=e.target.closest('.rxn'); if(!rxn) return
  const msg=e.target.closest('.msg'); if(!msg) return
  toggleReaction(msg.dataset.id, rxn.dataset.emoji).catch(console.error)
})
E.messages.addEventListener('dblclick', e=>{
  const msg=e.target.closest('.msg'); if(!msg) return
  const id=msg.dataset.id
  const who=$('.meta strong',msg)?.textContent||'anon'
  const text=$('.text',msg)?.textContent||''
  pinAdd({id,name:who,text,created_at:nowIso()})
})

/* ===== Pins ===== */
const pinsKey=()=>`pins:${S.room}`
function pinsLoad(){ try{S.pins=JSON.parse(localStorage.getItem(pinsKey())||'[]')}catch{S.pins=[]}; pinsRender() }
function pinsSave(){ localStorage.setItem(pinsKey(), JSON.stringify(S.pins)) }
function pinsRender(){
  E.pinList.innerHTML=''
  if(!S.pins.length){E.pinList.innerHTML=`<div class="small">No pins yet</div>`;return}
  for(const p of S.pins){
    const d=document.createElement('div')
    d.className='msg'
    d.dataset.pin=p.id
    d.innerHTML=`<div class="meta"><strong>${esc(p.name)}</strong> Â· ${new Date(p.created_at).toLocaleString()}</div><div class="text">${esc(p.text)}</div>`
    d.title='Double-click to unpin'
    d.ondblclick=()=>pinRemove(p.id)
    E.pinList.appendChild(d)
  }
}
function pinAdd(p){
  if(S.pins.find(x=>x.id===p.id)) return
  if(S.pins.length>=5) return alert('Pin board is full (max 5). Double-click a pin to remove.')
  S.pins.push(p); pinsSave(); pinsRender()
}
function pinRemove(id){S.pins=S.pins.filter(p=>p.id!==id); pinsSave(); pinsRender()}

/* ===== Presence / Rooms ===== */
async function heartbeat(){
  await supabase.from('presence').upsert({user_id:S.userId,name:S.name||'anon',room:S.room,updated_at:nowIso()})
}
async function refreshRooms(){
  const cutoff=new Date(Date.now()-90*1000).toISOString()

  const {data:all}=await supabase.from('presence').select('user_id').gt('updated_at',cutoff)
  E.globalOnline.textContent=`${new Set((all||[]).map(r=>r.user_id)).size} online (global)`

  const {data:rooms}=await supabase.from('presence').select('room,user_id').gt('updated_at',cutoff)
  const counts=new Map()
  for(const r of (rooms||[])){
    if(!counts.has(r.room)) counts.set(r.room,new Set())
    counts.get(r.room).add(r.user_id)
  }
  E.roomsList.innerHTML=''
  ;[...counts.entries()].sort((a,b)=>b[1].size-a[1].size).forEach(([room,set])=>{
    const d=document.createElement('span')
    d.className='roomPill'
    d.textContent=`#${room} Â· ${set.size}`
    d.onclick=()=>joinRoom(room)
    E.roomsList.appendChild(d)
  })
  E.roomsUpdated.textContent=new Date().toLocaleTimeString()
}

/* ===== Room state ===== */
async function loadRoomState(){
  const {data}=await supabase.from('room_state')
    .select('paused,paused_by,paused_name,muted_nicks,announcement_text,announcement_by,announcement_at')
    .eq('room',S.room).maybeSingle()

  setPaused(!!data?.paused, data?.paused_by||null, data?.paused_name||null)
  S.muted=new Set((data?.muted_nicks||[]).map(norm))
  E.muteList.textContent=S.muted.size?`Muted: ${[...S.muted].join(', ')}`:'Muted: (none)'
  renderAnnouncement(data?.announcement_text||'', data?.announcement_by||'', data?.announcement_at||'')
}
async function upsertRoomState(partial){
  const base={
    room:S.room,
    paused:S.paused, paused_by:S.pausedBy, paused_name:S.pausedName,
    muted_nicks:[...S.muted],
    announcement_text:E.announceText.textContent||null,
    announcement_by:E.announceBy.textContent||null,
    announcement_at:E.announceText.textContent?nowIso():null,
    updated_at:nowIso()
  }
  const {error}=await supabase.from('room_state').upsert({...base,...partial},{onConflict:'room'})
  if(error) throw error
}

/* ===== Banned terms / banned users ===== */
async function loadBannedTerms(){
  const {data}=await supabase.from('banned_terms').select('term')
  S.bannedTerms=new Set((data||[]).map(r=>norm(r.term)))
  E.banList.textContent=S.bannedTerms.size?`Banned terms: ${[...S.bannedTerms].join(', ')}`:'Banned terms: (none)'
}
async function checkBan(){
  const {data}=await supabase.from('banned_users').select('user_id').eq('user_id',S.userId).maybeSingle()
  S.banned=!!data; updateComposerDisabled()
}
async function lookupUserIdByNick(nick){
  const {data}=await supabase.from('presence').select('user_id,name,updated_at')
  return (data||[]).sort((a,b)=>new Date(b.updated_at)-new Date(a.updated_at)).find(r=>norm(r.name)===norm(nick))?.user_id||null
}
async function refreshBannedList(){
  const {data}=await supabase.from('banned_users').select('user_id,name').order('created_at',{ascending:false})
  E.bannedList.textContent=(data?.length)?`Banned: ${data.map(r=>r.name||r.user_id).join(', ')}`:'Banned: (none)'
}

/* ===== History / reactions ===== */
async function loadReactionsFor(ids){
  if(!ids.length) return
  const {data}=await supabase.from('message_reactions')
    .select('message_id,emoji,user_id').eq('room',S.room).in('message_id',ids)
  for(const r of (data||[])){
    const map=S.reactions.get(r.message_id)||{}
    map[r.emoji]=map[r.emoji]||new Set()
    map[r.emoji].add(r.user_id)
    S.reactions.set(r.message_id,map)
  }
  ids.forEach(renderReactions)
}
async function loadRecent(){
  if(!PERSIST) return
  clearUI()
  const {data,error}=await supabase.from('messages').select('*')
    .eq('room',S.room).order('created_at',{ascending:false}).limit(MAX_MSGS)
  if(error){console.error(error);return sys('Failed to load history')}
  const list=(data||[]).reverse()
  list.forEach(addIfNew)
  await loadReactionsFor(list.map(msgKey))
}

/* ===== Send ===== */
async function send(){
  const text=(E.input.value||'').trim()
  if(!text) return
  if(text.length>300) return alert('Max 300 characters')
  if(S.kicked) return alert('You were kicked. Refresh to rejoin.')
  if(S.banned) return alert('You are banned.')
  if(S.muted.has(norm(S.name))&&!S.admin) return alert('You are muted.')
  if(S.paused&&S.userId!==S.pausedBy) return alert(`Chat is paused by ${S.pausedName||'admin'}.`)
  if(violates(text)) return alert('Message blocked by moderation.')

  const name=(E.name.value||'anon').slice(0,20)
  E.name.value=name; S.name=name
  localStorage.setItem('nickname',name)
  localStorage.setItem('uid',S.userId)

  const msg={room:S.room,user_id:S.userId,name,text,created_at:nowIso(),color:S.color}
  E.input.value=''
  S.roomChannel?.send({type:'broadcast',event:'msg',payload:msg})
  addIfNew(msg)

  if(PERSIST){
    const {error}=await supabase.from('messages').insert(msg)
    if(error) console.error(error)
  }
}

/* ===== Holiday ===== */
function applyHoliday(id='none'){
  S.holiday=id
  localStorage.setItem('holiday',id)
  document.body.classList.forEach(c=>{ if(c.startsWith('holiday-')) document.body.classList.remove(c) })
  if(id!=='none') document.body.classList.add(`holiday-${id}`)
  const meta=HOLIDAYS[id]||{label:id,emoji:''}
  E.holidayActive.textContent=id==='none'?'off':`${meta.emoji} ${meta.label}`.trim()
}
function initHoliday(){
  E.holidaySelect.innerHTML=Object.entries(HOLIDAYS).map(([id,cfg])=>
    `<option value="${esc(id)}">${esc((cfg.emoji?cfg.emoji+' ':'')+cfg.label)}</option>`
  ).join('')
  E.holidaySelect.value=S.holiday
  applyHoliday(S.holiday)
}

/* ===== Join room ===== */
async function joinRoom(newRoom){
  newRoom=(newRoom||'global').toLowerCase().replace(/[^a-z0-9_-]/g,'-')

  if(S.roomChannel){ await supabase.removeChannel(S.roomChannel); S.roomChannel=null }
  clearUI(); S.kicked=false; E.blocker.style.display='none'

  S.room=newRoom
  localStorage.setItem('room',S.room)
  E.roomInput.value=S.room
  E.roomNameLabel.textContent=S.room
  pinsLoad()
  syncNotifToggles()
  S.lastPresenceCount=0

  S.roomChannel=supabase.channel(`room:${S.room}`,{config:{presence:{key:S.userId}}})

  S.roomChannel.on('presence',{event:'sync'},async()=>{
    const pres=S.roomChannel.presenceState()
    const users=new Set()
    for(const k in pres) pres[k].forEach(v=>users.add(v.userId))
    const count=users.size
    E.online.textContent=`${count} online`

    if(S.notifyJoinsRooms.has(S.room) && count>S.lastPresenceCount){
      const ok=await ensureNotifPermission()
      if(ok) notify(`#${S.room}`, `Someone joined (${count} online)`)
    }
    S.lastPresenceCount=count
  })

  if(PERSIST){
    S.roomChannel.on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`room=eq.${S.room}`},p=>{
      addIfNew(p.new)
      const m=p.new
      if(S.notifyRooms.has(S.room) && m?.user_id!==S.userId){
        ensureNotifPermission().then(ok=>{
          if(ok) notify(`#${S.room}`, `${m.name||'anon'}: ${(m.text||'').slice(0,90)}`)
        })
      }
    })

    S.roomChannel.on('postgres_changes',{event:'*',schema:'public',table:'room_state',filter:`room=eq.${S.room}`},p=>{
      const row=p.new||p.old||{}
      setPaused(!!row.paused,row.paused_by||null,row.paused_name||null)
      S.muted=new Set((row.muted_nicks||[]).map(norm))
      E.muteList.textContent=S.muted.size?`Muted: ${[...S.muted].join(', ')}`:'Muted: (none)'
      renderAnnouncement(row.announcement_text||'',row.announcement_by||'',row.announcement_at||'')
    })

    S.roomChannel.on('postgres_changes',{event:'INSERT',schema:'public',table:'message_reactions',filter:`room=eq.${S.room}`},({new:r})=>{
      const map=S.reactions.get(r.message_id)||{}
      map[r.emoji]=map[r.emoji]||new Set()
      map[r.emoji].add(r.user_id)
      S.reactions.set(r.message_id,map)
      renderReactions(r.message_id)
    })
    S.roomChannel.on('postgres_changes',{event:'DELETE',schema:'public',table:'message_reactions',filter:`room=eq.${S.room}`},({old:r})=>{
      const map=S.reactions.get(r.message_id)||{}
      map[r.emoji]?.delete(r.user_id)
      S.reactions.set(r.message_id,map)
      renderReactions(r.message_id)
    })
  }

  S.roomChannel.on('broadcast',{event:'msg'},({payload})=>{
    addIfNew(payload)
    if(S.notifyRooms.has(S.room) && payload?.user_id!==S.userId){
      ensureNotifPermission().then(ok=>{
        if(ok) notify(`#${S.room}`, `${payload.name||'anon'}: ${(payload.text||'').slice(0,90)}`)
      })
    }
  })
  S.roomChannel.on('broadcast',{event:'rxn'},({payload})=>{
    const id=payload.message_id
    const map=S.reactions.get(id)||{}
    map[payload.emoji]=map[payload.emoji]||new Set()
    payload.op==='add'?map[payload.emoji].add(payload.user_id):map[payload.emoji].delete(payload.user_id)
    S.reactions.set(id,map); renderReactions(id)
  })
  S.roomChannel.on('broadcast',{event:'admin'},({payload})=>{
    if(!payload) return
    if(payload.type==='clear'){clearUI();sys('Chat cleared by admin')}
    if(payload.type==='pause') setPaused(true,payload.by||null,payload.name||'admin')
    if(payload.type==='unpause') setPaused(false,null,null)
    if(payload.type==='kick' && norm(S.name)===norm(payload.nick)) showBlocker()
    if(payload.type==='muted'){S.muted.add(norm(payload.nick));E.muteList.textContent=`Muted: ${[...S.muted].join(', ')}`;updateComposerDisabled()}
    if(payload.type==='unmuted'){S.muted.delete(norm(payload.nick));E.muteList.textContent=S.muted.size?`Muted: ${[...S.muted].join(', ')}`:'Muted: (none)';updateComposerDisabled()}
    if(payload.type==='announce') renderAnnouncement(payload.text||'',payload.by||'admin',nowIso())
    if(payload.type==='ban' && payload.user_id===S.userId){S.banned=true;updateComposerDisabled();alert('You have been banned by the owner.')}
    if(payload.type==='unban' && payload.user_id===S.userId){S.banned=false;updateComposerDisabled();sys('You were unbanned')}
    if(payload.type==='holiday') applyHoliday(payload.theme||'none')
  })

  await S.roomChannel.subscribe(async st=>{
    if(st!=='SUBSCRIBED') return
    S.roomChannel.track({userId:S.userId,name:S.name||'anon',room:S.room})
    await loadRecent()
    await loadRoomState()
    await loadBannedTerms()
    await checkBan()
    initHoliday()
    renderSwatches()
    sys(`Joined #${S.room}`)
    await heartbeat()
    await refreshRooms()
    clearInterval(S.presenceTimer)
    S.presenceTimer=setInterval(()=>heartbeat().catch(()=>{}),20000)
  })
}

/* ===== Wire controls ===== */
function roleFromPass(p){
  p=(p||'').trim(); if(!p) return null
  if(p.toLowerCase()===OWNER_PASS.toLowerCase()) return 'owner'
  if(p.toLowerCase()===ADMIN_PASS.toLowerCase()) return 'admin'
  return null
}
E.unlock.onclick=()=>{const r=roleFromPass(E.pass.value); r?(setRole(r),E.pass.value='',refreshBannedList().catch(()=>{})):alert('Wrong passcode')}
E.pass.addEventListener('keydown',e=>{if(e.key==='Enter')E.unlock.click()})

E.send.onclick=send
E.input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}})
E.switchRoom.onclick=()=>joinRoom(E.roomInput.value)
E.roomInput.addEventListener('keydown',e=>{if(e.key==='Enter')joinRoom(E.roomInput.value)})

E.name.value=S.name
E.name.addEventListener('change',()=>{
  const n=(E.name.value||'anon').slice(0,20)
  E.name.value=n; S.name=n
  localStorage.setItem('nickname',n)
  updateComposerDisabled()
  heartbeat().catch(()=>{})
})

E.notifToggle.addEventListener('change', async ()=>{
  const on=E.notifToggle.checked
  if(on){
    const ok=await ensureNotifPermission()
    if(!ok){E.notifToggle.checked=false;return alert('Notifications are blocked in your browser settings.')}
    S.notifyRooms.add(S.room)
  }else S.notifyRooms.delete(S.room)
  saveNotifySets()
})
E.joinToggle.addEventListener('change', async ()=>{
  const on=E.joinToggle.checked
  if(on){
    const ok=await ensureNotifPermission()
    if(!ok){E.joinToggle.checked=false;return alert('Notifications are blocked in your browser settings.')}
    S.notifyJoinsRooms.add(S.room)
  }else S.notifyJoinsRooms.delete(S.room)
  saveNotifySets()
})

E.pauseBtn.onclick=async()=>{
  if(!S.admin) return
  try{
    await upsertRoomState({paused:true,paused_by:S.userId,paused_name:S.name||'anon'})
    setPaused(true,S.userId,S.name||'anon')
    S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'pause',by:S.userId,name:S.name||'anon'}})
  }catch(e){console.error(e);alert('Pause failed (check table & policies).')}
}
E.unpauseBtn.onclick=async()=>{
  if(!S.admin) return
  try{
    await upsertRoomState({paused:false,paused_by:null,paused_name:null})
    setPaused(false,null,null)
    S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'unpause'}})
  }catch(e){console.error(e);alert('Unpause failed (check table & policies).')}
}
E.clearBtn.onclick=async()=>{
  if(!S.admin) return
  if(!confirm(`Clear ALL messages in #${S.room}?`)) return
  const {error}=await supabase.from('messages').delete().eq('room',S.room)
  if(error){console.error(error);return alert('Clear failed (need DELETE policy).')}
  clearUI(); sys('Chat cleared.')
  S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'clear'}})
}
E.kickBtn.onclick=()=>{
  if(!S.admin) return
  const nick=norm(E.targetNick.value); if(!nick) return alert('Enter a nickname')
  S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'kick',nick}})
  sys(`Kicked ${nick}`)
}
E.muteBtn.onclick=async()=>{
  if(!S.admin) return
  const nick=norm(E.targetNick.value); if(!nick) return alert('Enter a nickname')
  S.muted.add(nick); E.muteList.textContent=`Muted: ${[...S.muted].join(', ')}`
  updateComposerDisabled()
  try{ await upsertRoomState({muted_nicks:[...S.muted]}) }catch(e){console.error(e);alert('Failed to update mute list.')}
  S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'muted',nick}})
}
E.unmuteBtn.onclick=async()=>{
  if(!S.admin) return
  const nick=norm(E.targetNick.value); if(!nick) return alert('Enter a nickname')
  S.muted.delete(nick); E.muteList.textContent=S.muted.size?`Muted: ${[...S.muted].join(', ')}`:'Muted: (none)'
  updateComposerDisabled()
  try{ await upsertRoomState({muted_nicks:[...S.muted]}) }catch(e){console.error(e);alert('Failed to update mute list.')}
  S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'unmuted',nick}})
}
E.setAnnBtn.onclick=async()=>{
  if(!S.admin) return
  const text=(E.announceInput.value||'').trim(); if(!text) return alert('Type an announcement')
  try{
    await supabase.from('room_state').upsert({room:S.room,announcement_text:text,announcement_by:S.name||'admin',announcement_at:nowIso()},{onConflict:'room'})
    renderAnnouncement(text,S.name||'admin',nowIso())
    S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'announce',text,by:S.name||'admin'}})
  }catch(e){console.error(e);alert('Set announcement failed.')}
}
E.clrAnnBtn.onclick=async()=>{
  if(!S.admin) return
  try{
    await supabase.from('room_state').upsert({room:S.room,announcement_text:null,announcement_by:null,announcement_at:null},{onConflict:'room'})
    renderAnnouncement('','','')
    S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'announce',text:'',by:''}})
  }catch(e){console.error(e);alert('Clear announcement failed.')}
}
E.addBan.onclick=async()=>{
  if(!S.admin) return
  const term=(E.banTerm.value||'').trim().toLowerCase(); if(!term) return alert('Enter a term')
  const {error}=await supabase.from('banned_terms').insert({term})
  if(error){console.error(error);return alert('Failed to add term')}
  E.banTerm.value=''; await loadBannedTerms()
}
E.delBan.onclick=async()=>{
  if(!S.admin) return
  const term=(E.banTerm.value||'').trim().toLowerCase(); if(!term) return alert('Enter a term')
  const {error}=await supabase.from('banned_terms').delete().eq('term',term)
  if(error){console.error(error);return alert('Failed to remove term')}
  E.banTerm.value=''; await loadBannedTerms()
}
E.holidayApply.onclick=()=>{
  if(!S.admin) return
  const val=E.holidaySelect.value||'none'
  applyHoliday(val)
  S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'holiday',theme:val}})
}
E.holidayClear.onclick=()=>{
  if(!S.admin) return
  E.holidaySelect.value='none'
  applyHoliday('none')
  S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'holiday',theme:'none'}})
}
E.banBtn.onclick=async()=>{
  if(S.role!=='owner') return alert('Owner only')
  const nick=norm(E.banNick.value); if(!nick) return alert('Enter a nickname')
  const uid=await lookupUserIdByNick(nick); if(!uid) return alert('User not found online.')
  const {error}=await supabase.from('banned_users').upsert({user_id:uid,name:nick})
  if(error){console.error(error);return alert('Ban failed')}
  S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'ban',user_id:uid}})
  await refreshBannedList()
}
E.unbanBtn.onclick=async()=>{
  if(S.role!=='owner') return alert('Owner only')
  const nick=norm(E.banNick.value); if(!nick) return alert('Enter a nickname')
  let uid=await lookupUserIdByNick(nick)
  if(!uid){
    const {data}=await supabase.from('banned_users').select('user_id,name')
    uid=(data||[]).find(r=>norm(r.name)===nick)?.user_id||null
  }
  if(!uid) return alert('Could not resolve user to unban')
  const {error}=await supabase.from('banned_users').delete().eq('user_id',uid)
  if(error){console.error(error);return alert('Unban failed')}
  S.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'unban',user_id:uid}})
  await refreshBannedList()
}

/* ===== Boot ===== */
setRole('guest')
setStatus('Ready')
E.roomInput.value=S.room
E.name.value=S.name
syncNotifToggles()
initHoliday()
renderSwatches()
updateComposerDisabled()

joinRoom(S.room).catch(console.error)

window.addEventListener('beforeunload',()=>{ supabase.from('presence').delete().eq('user_id',S.userId) })

const presenceChan=supabase.channel('presence-global')
presenceChan.on('postgres_changes',{event:'*',schema:'public',table:'presence'},()=>refreshRooms().catch(()=>{}))
presenceChan.subscribe()
setInterval(()=>refreshRooms().catch(()=>{}),15000)

window.addEventListener('online', ()=>setStatus('Online'))
window.addEventListener('offline',()=>setStatus('Offline'))
</script>
</body>
</html>
