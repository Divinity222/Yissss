<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Global Chat â€” Supabase</title>
<style>
:root{--bg:#0f172a;--panel:#111827;--accent:#22d3ee;--muted:#94a3b8;--text:#e5e7eb;--ann:#f59e0b}
*{box-sizing:border-box}
body{margin:0;font:16px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(180deg,#0b1025,#0f172a);color:var(--text);display:flex;min-height:100vh}
.container{max-width:1320px;margin:0 auto;flex:1;display:flex;flex-direction:column;padding:16px;gap:12px}
header{display:flex;align-items:center;gap:10px}
header h1{margin:0;font-size:20px;letter-spacing:.3px}
header .badge{padding:4px 8px;border-radius:999px;background:#0ea5a5;font-size:12px}
.card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
#room{padding:10px 14px;display:flex;align-items:center;gap:8px}
#room input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;color:var(--text)}
#room button,.btn{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#001018;font-weight:700;cursor:pointer}
.layout{display:grid;grid-template-columns:220px 1fr 300px 300px;gap:12px;min-height:0}
@media (max-width:1320px){.layout{grid-template-columns:220px 1fr 300px}}
@media (max-width:1024px){.layout{grid-template-columns:1fr}}
#rules{padding:12px;display:flex;flex-direction:column;gap:8px}
#rules h3{margin:0;font-size:14px}
#rules ol{margin:0;padding-left:18px;color:#cbd5e1;line-height:1.35}
#chat{display:flex;min-height:0;gap:12px;flex-direction:column}
#messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.msg{padding:10px 12px;border-radius:12px;background:#0b1226;border:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;gap:6px;cursor:pointer}
.meta{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
.me .meta strong{color:#a7f3d0}
.text{line-height:1.4;white-space:pre-wrap;word-wrap:anywhere}
.sys{text-align:center;font-size:12px;color:var(--muted);margin:8px 0}
#composer{padding:10px;display:flex;gap:8px}
#composer input[type="text"]{width:180px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;color:var(--text)}
#composer textarea{flex:1;min-height:44px;max-height:120px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;resize:vertical;color:var(--text)}
#composer button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#001018;font-weight:700;cursor:pointer}
footer{text-align:center;font-size:12px;color:var(--muted);padding:8px 0 0}
.row{display:flex;gap:12px;align-items:center}
.grow{flex:1}
#announce{display:none;position:sticky;top:0;z-index:2;margin:0 12px;padding:12px;border-radius:12px;background:linear-gradient(90deg,rgba(245,158,11,.18),rgba(245,158,11,.08));border:1px solid var(--ann);box-shadow:0 4px 20px rgba(245,158,11,.15)}
#announce .label{font-weight:700;text-transform:uppercase;font-size:12px;letter-spacing:.06em;color:#fff;background:var(--ann);padding:2px 8px;border-radius:999px;display:inline-block;margin-bottom:6px}
#announce .txt{font-size:15px}
#announce .who{font-size:12px;color:#ffd79a;margin-top:6px}
#admin{padding:12px;display:flex;flex-direction:column;gap:10px}
#admin h3{margin:0;font-size:14px;letter-spacing:.2px}
#admin .small{font-size:12px;color:var(--muted)}
#admin input[type="password"],#admin input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;color:var(--text)}
#admin .btn-row{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
.danger{background:#fca5a5;color:#220}
.warn{background:#fde68a;color:#221}
#muteList,#banList{font-size:12px;color:var(--muted)}
#pins{padding:12px;display:flex;flex-direction:column;gap:10px}
#pins h3{margin:0;font-size:14px}
#pinList{display:flex;flex-direction:column;gap:8px;max-height:400px;overflow:auto}
.pin{padding:10px 12px;border-radius:12px;background:#0b1226;border:1px solid rgba(255,255,255,.12);cursor:pointer}
.pin .meta{font-size:12px;color:var(--muted)}
.pin:hover{outline:1px dashed rgba(255,255,255,.25)}
.hint{font-size:12px;color:var(--muted)}
.reactions{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.rxn{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);cursor:pointer;font-size:13px;user-select:none}
.rxn.mine{outline:1px solid var(--accent)}
@keyframes partyHue{from{filter:hue-rotate(0deg) saturate(1.25) contrast(1.05)}to{filter:hue-rotate(360deg) saturate(1.25) contrast(1.05)}}
body.disco{animation:partyHue 1s linear infinite}
@keyframes fxPulse{0%{filter:saturate(1)}50%{filter:saturate(1.6) brightness(1.15)}100%{filter:saturate(1)}}
body.pulse{animation:fxPulse 1s ease-in-out infinite}
@keyframes fxShake{0%,100%{transform:translate(0,0)}25%{transform:translate(2px,-2px)}50%{transform:translate(-2px,2px)}75%{transform:translate(2px,2px)}}
body.shake{animation:fxShake .1s linear infinite}
@keyframes confettiFall{to{transform:translateY(110vh) rotate(720deg)}}
.confetti{position:fixed;width:6px;height:6px;top:-10px;will-change:transform;animation:confettiFall linear forwards;z-index:9998;border-radius:2px}
.blocker{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999}
.blocker-inner{max-width:520px;text-align:center;padding:24px;border-radius:16px;background:#0b1226;border:1px solid rgba(255,255,255,.12)}
.blocker h2{margin:0 0 10px;font-size:20px}
#fun{padding:12px;display:flex;flex-direction:column;gap:10px}
#fun h3{margin:0;font-size:14px}
#colorRow{display:flex;gap:8px;flex-wrap:wrap}
.swatch{width:24px;height:24px;border-radius:999px;border:2px solid rgba(255,255,255,.25);cursor:pointer;box-shadow:inset 0 0 0 1px rgba(0,0,0,.15)}
.swatch.sel{outline:2px solid #fff}
#gameSel{width:100%;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;color:var(--text)}
#game{min-height:120px;background:#0b1226;border:1px dashed rgba(255,255,255,.15);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;color:#cbd5e1}
.ttt{display:grid;grid-template-columns:repeat(3,60px);gap:6px}
.ttt button{width:60px;height:60px;font-size:22px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:#111a2e;color:#fff;cursor:pointer}
.mem{display:grid;grid-template-columns:repeat(4,44px);gap:6px}
.mem button{width:44px;height:44px;font-size:18px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#111a2e;color:#fff;cursor:pointer}
#roomsCard{padding:10px}
#roomsList{display:flex;flex-wrap:wrap;gap:8px}
.roomPill{padding:6px 10px;border-radius:999px;background:#0b1226;border:1px solid rgba(255,255,255,.12);font-size:12px}
</style>
<link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3ctext y='14' font-size='14'%3e%F0%9F%92%AC%3c/text%3e%3c/svg%3e" />
</head>
<body>
<div id="blocker" class="blocker" style="display:none"><div class="blocker-inner"><h2>You've been kicked</h2><p class="small">An admin removed you from the room. Refresh the page to rejoin.</p></div></div>
<div class="container">
<header>
<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 15a4 4 0 01-4 4H7l-4 4V7a4 4 0 014-4h10a4 4 0 014 4v8z" stroke="#22d3ee" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
<h1>Global Chat â€” Supabase</h1>
<span class="badge" id="online">â€¦</span>
<span class="badge" id="globalOnline">â€¦</span>
<div class="grow"></div>
<span class="meta" id="status">Connectingâ€¦</span>
</header>
<div id="room" class="card"><div class="row" style="width:100%"><label class="meta" for="roomInput">Room:</label><input id="roomInput" placeholder="global" /><button id="switchRoom">Join</button></div></div>
<div id="roomsCard" class="card"><div class="row" style="justify-content:space-between;align-items:center"><div class="meta">Open rooms</div><div class="meta" id="roomsUpdated"></div></div><div id="roomsList"></div></div>
<div class="layout">
<aside id="rules" class="card"><h3>Rules</h3><ol>
<li>No offensive and or unsafe topics/names</li>
<li>Slurs and or offensive nicknames will be filtered and removed.</li>
<li>Abusing admin is a access removeable offense.</li>
<li>Drama has to end QUICKLY OR. Go into a private room to prevent punishment.</li>
<li>All forms of venting must be done in rooms Vent 1-3 OR have to be brief spanning below 10 minutes. Talking about a bad day isnt venting.</li>
</ol></aside>
<div id="chat" class="card">
<div id="announce"><div class="label">ðŸ“¢ Announcement</div><div id="announceText" class="txt"></div><div class="who">â€” <span id="announceBy"></span> <span id="announceAt"></span></div></div>
<div id="messages"></div>
<div id="composer"><input id="name" placeholder="Nickname" maxlength="20" /><textarea id="input" placeholder="Type a messageâ€¦ (Shift+Enter = newline)" maxlength="300"></textarea><button id="send">Send</button></div>
</div>
<aside id="admin" class="card">
<div class="row" style="justify-content:space-between;align-items:center"><h3>Admin</h3><span id="pausePill" class="pill">Status: <strong id="pauseState">active</strong></span></div>
<div id="adminLocked"><p class="small">Enter passcode to unlock controls.</p><input id="pass" type="password" placeholder="Passcode" /><div class="btn-row"><button id="unlock" class="btn">Unlock</button></div></div>
<div id="adminControls" style="display:none">
<p class="small">Controls are scoped to the current room (<span id="roomNameLabel">global</span>).</p>
<div class="btn-row"><button id="pauseBtn" class="btn warn">Pause</button><button id="unpauseBtn" class="btn">Unpause</button><button id="clearBtn" class="btn danger">Clear</button><button id="discoBtn" class="btn">Disco 10s</button><button id="fxPulse" class="btn">Pulse 8s</button><button id="fxShake" class="btn">Shake 5s</button><button id="fxConfetti" class="btn">Confetti</button></div>
<hr style="opacity:.15"><div class="row" style="flex-direction:column;align-items:stretch;gap:8px"><input id="targetNick" type="text" placeholder="Nickname (case-insensitive)" /><div class="btn-row"><button id="kickBtn" class="btn danger">Kick</button><button id="muteBtn" class="btn warn">Mute</button><button id="unmuteBtn" class="btn">Unmute</button></div><div id="muteList" class="small"></div></div>
<hr style="opacity:.15"><div class="row" style="flex-direction:column;align-items:stretch;gap:8px"><input id="announceInput" type="text" placeholder="Announcement text" /><div class="btn-row"><button id="setAnnBtn" class="btn">Set announcement</button><button id="clrAnnBtn" class="btn danger">Clear announcement</button></div></div>
<hr style="opacity:.15"><div class="row" style="flex-direction:column;align-items:stretch;gap:8px"><input id="banTerm" type="text" placeholder="Add banned term (admin)" /><div class="btn-row"><button id="addBan" class="btn warn">Add term</button><button id="delBan" class="btn">Remove term</button></div><div id="banList" class="small"></div></div>
<hr style="opacity:.15"><div id="ownerOnly" style="display:none" class="row"><div style="width:100%"><div class="small">Owner tools</div><div class="row" style="flex-direction:column;align-items:stretch;gap:8px"><input id="banNick" type="text" placeholder="Ban by nickname (current online)" /><div class="btn-row"><button id="banBtn" class="btn danger">Ban</button><button id="unbanBtn" class="btn">Unban</button></div><div id="bannedList" class="small"></div></div></div></div>
</div>
</aside>
<aside id="pins" class="card"><h3>Pinned (max 5)</h3><div class="hint">Doubleâ€‘click any message to pin. Doubleâ€‘click a pin to unpin.</div><div id="pinList"></div></aside>
<aside id="fun" class="card"><h3>Fun & Style</h3><div class="row" id="colorRow"></div><select id="gameSel"><option value="rps">Rock â€¢ Paper â€¢ Scissors</option><option value="ttt">Ticâ€‘Tacâ€‘Toe</option><option value="guess">Number Guess</option><option value="mem">Memory Match</option><option value="react">Reaction Test</option></select><div id="game">Pick a game</div></aside>
</div>
<footer>Free realtime chat powered by Supabase (Postgres + Realtime). Keep it friendly âœ¨</footer>
</div>
<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
const SUPABASE_URL='https://prpjfrqfbbsxqhspqheo.supabase.co'
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBycGpmcnFmYmJzeHFoc3BxaGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNjgwMDksImV4cCI6MjA3Mzc0NDAwOX0.XEUz5g-tzW4UAsKLk62FJratwaLYAL-1noBTu0EwTkY'
const PERSIST=true
const MAX_MSGS=15
const ADMIN_PASS='DivinePermissions'
const OWNER_PASS='ServerHostPanel'
const REACTIONS=['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ˜¡']
const COLORS=['#ffffff','#22d3ee','#f43f5e','#a3e635','#f59e0b','#8b5cf6']
const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY)
const els={status:document.getElementById('status'),input:document.getElementById('input'),send:document.getElementById('send'),messages:document.getElementById('messages'),name:document.getElementById('name'),online:document.getElementById('online'),globalOnline:document.getElementById('globalOnline'),roomsList:document.getElementById('roomsList'),roomsUpdated:document.getElementById('roomsUpdated'),roomInput:document.getElementById('roomInput'),switchRoom:document.getElementById('switchRoom'),adminLocked:document.getElementById('adminLocked'),adminControls:document.getElementById('adminControls'),pass:document.getElementById('pass'),unlock:document.getElementById('unlock'),pauseBtn:document.getElementById('pauseBtn'),unpauseBtn:document.getElementById('unpauseBtn'),clearBtn:document.getElementById('clearBtn'),discoBtn:document.getElementById('discoBtn'),pauseState:document.getElementById('pauseState'),roomNameLabel:document.getElementById('roomNameLabel'),pausePill:document.getElementById('pausePill'),targetNick:document.getElementById('targetNick'),kickBtn:document.getElementById('kickBtn'),muteBtn:document.getElementById('muteBtn'),unmuteBtn:document.getElementById('unmuteBtn'),blocker:document.getElementById('blocker'),announce:document.getElementById('announce'),announceText:document.getElementById('announceText'),announceBy:document.getElementById('announceBy'),announceAt:document.getElementById('announceAt'),announceInput:document.getElementById('announceInput'),setAnnBtn:document.getElementById('setAnnBtn'),clrAnnBtn:document.getElementById('clrAnnBtn'),pinList:document.getElementById('pinList'),banTerm:document.getElementById('banTerm'),addBan:document.getElementById('addBan'),delBan:document.getElementById('delBan'),banList:document.getElementById('banList'),ownerOnly:document.getElementById('ownerOnly'),banNick:document.getElementById('banNick'),banBtn:document.getElementById('banBtn'),unbanBtn:document.getElementById('unbanBtn'),bannedList:document.getElementById('bannedList'),colorRow:document.getElementById('colorRow'),gameSel:document.getElementById('gameSel'),game:document.getElementById('game'),fxPulse:document.getElementById('fxPulse'),fxShake:document.getElementById('fxShake'),fxConfetti:document.getElementById('fxConfetti')}
let state={room:localStorage.getItem('room')||'global',name:localStorage.getItem('nickname')||'',userId:localStorage.getItem('uid')||crypto.randomUUID(),role:'guest',roomChannel:null,admin:false,paused:false,pausedBy:null,pausedName:null,discoTimer:null,mutedNicks:new Set(),kicked:false,pins:[],reactions:new Map(),bannedTerms:new Set(),banned:false,color:localStorage.getItem('color')||COLORS[0],presenceTimer:null}
const rendered=new Set()
const msgKey=m=>`${m.user_id}|${m.created_at}|${m.text}`
const norm=s=>(s||'').trim().toLowerCase()
function setStatus(t){els.status.textContent=t}
function sys(text){const d=document.createElement('div');d.className='sys';d.textContent=text;els.messages.appendChild(d);els.messages.scrollTop=els.messages.scrollHeight}
function collapseRepeats(t){let o='',p='',c=0;for(const ch of t){if(ch===p){c++;if(c<=2)o+=ch}else{p=ch;c=1;o+=ch}}return o}
function normalizeForModeration(s){if(!s)return'';let t=s.toLowerCase();t=t.replace(/[@]/g,'a').replace(/[0]/g,'o').replace(/[1l!]/g,'i').replace(/[3]/g,'e').replace(/[4]/g,'a').replace(/[5$]/g,'s').replace(/[7]/g,'t');t=t.replace(/[^a-z0-9]+/g,'');t=collapseRepeats(t);return t}
function violatesModeration(text){const n=normalizeForModeration(text);for(const term of state.bannedTerms){if(n.includes(term))return true}return false}
function maskModeration(text){return violatesModeration(text)?'ðŸš« [filtered]':text}
function escapeHtml(s){return(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}
function renderMsg(m){const wrap=document.createElement('div');const mine=m.user_id===state.userId;const id=msgKey(m);wrap.className='msg'+(mine?' me':'');wrap.dataset.id=id;const meta=document.createElement('div');meta.className='meta';const when=new Date(m.created_at||Date.now());meta.innerHTML=`<strong>${escapeHtml(m.name||'anon')}</strong> Â· ${when.toLocaleString()}${mine?' Â· you':''}`;const text=document.createElement('div');text.className='text';text.style.color=m.color||'';text.textContent=maskModeration(m.text);const rxn=document.createElement('div');rxn.className='reactions';REACTIONS.forEach(e=>{const b=document.createElement('span');b.className='rxn';b.dataset.emoji=e;b.textContent=e;b.addEventListener('click',()=>toggleReaction(id,e));rxn.appendChild(b)});wrap.appendChild(meta);wrap.appendChild(text);wrap.appendChild(rxn);wrap.title='Doubleâ€‘click to pin';wrap.addEventListener('dblclick',()=>pinMessage(m));els.messages.appendChild(wrap);renderReactions(id)}
function renderReactions(id){const wrap=els.messages.querySelector(`.msg[data-id="${CSS.escape(id)}"]`);if(!wrap)return;const bar=wrap.querySelector('.reactions');const map=state.reactions.get(id)||{};[...bar.children].forEach(node=>{const emo=node.dataset.emoji;const set=map[emo]||new Set();node.textContent=`${emo} ${set.size||''}`.trim();if(set.has(state.userId))node.classList.add('mine');else node.classList.remove('mine')})}
async function toggleReaction(messageId,emoji){const map=state.reactions.get(messageId)||{};map[emoji]=map[emoji]||new Set();const has=map[emoji].has(state.userId);if(has){map[emoji].delete(state.userId);state.reactions.set(messageId,map);renderReactions(messageId);await supabase.from('message_reactions').delete().match({room:state.room,message_id:messageId,emoji,user_id:state.userId});state.roomChannel.send({type:'broadcast',event:'rxn',payload:{op:'del',message_id:messageId,emoji,user_id:state.userId}})}else{map[emoji].add(state.userId);state.reactions.set(messageId,map);renderReactions(messageId);await supabase.from('message_reactions').insert({room:state.room,message_id:messageId,emoji,user_id:state.userId});state.roomChannel.send({type:'broadcast',event:'rxn',payload:{op:'add',message_id:messageId,emoji,user_id:state.userId}})}}
function trimUI(){const nodes=[...els.messages.querySelectorAll('.msg')];const extra=nodes.length-MAX_MSGS;for(let i=0;i<extra;i++)nodes[i].remove();els.messages.scrollTop=els.messages.scrollHeight}
function clearUI(){els.messages.innerHTML='';rendered.clear()}
function addIfNew(m){const k=msgKey(m);if(rendered.has(k))return;rendered.add(k);renderMsg(m);trimUI()}
// --- replace your setRole with this ---
function setRole(role){
  state.role = role;
  state.admin = role === 'admin' || role === 'owner';
  // force visibility explicitly
  els.adminLocked.style.display   = state.admin ? 'none'  : '';
  els.adminControls.style.display = state.admin ? 'block' : 'none';
  els.ownerOnly.style.display     = role === 'owner' ? 'block' : 'none';
}

// --- replace your roleFromPass with this ---
function roleFromPass(p){
  const v = (p || '').trim();
  if (!v) return null;
  if (v === OWNER_PASS || v.toLowerCase() === OWNER_PASS.toLowerCase()) return 'owner';
  if (v === ADMIN_PASS || v.toLowerCase() === ADMIN_PASS.toLowerCase()) return 'admin';
  return null;
}

// --- add this helper + listeners (or replace your existing unlock listener) ---
function unlockAdmin(){
  const role = roleFromPass(els.pass.value);
  if (role){
    setRole(role);
    els.pass.value = '';
  } else {
    alert('Wrong passcode');
  }
}
els.unlock.addEventListener('click', unlockAdmin);
els.pass.addEventListener('keydown', e => { if (e.key === 'Enter') unlockAdmin(); });

function setPaused(p,byId=null,byName=null){state.paused=!!p;state.pausedBy=byId;state.pausedName=byName;const who=state.paused?(state.pausedName?`paused by ${escapeHtml(state.pausedName)}`:'paused'):'active';els.pauseState.textContent=who;els.pausePill.style.background=state.paused?'#fde68a':'rgba(255,255,255,.08)';updateComposerDisabled()}
function updateComposerDisabled(){const blocked=(state.paused&&state.userId!==state.pausedBy)||state.kicked||state.mutedNicks.has(norm(state.name))||state.banned;els.input.disabled=blocked;els.send.disabled=blocked;if(state.kicked){els.input.placeholder='You were kicked. Refresh to rejoin.'}else if(state.banned){els.input.placeholder='You are banned.'}else if(state.mutedNicks.has(norm(state.name))){els.input.placeholder='You are muted by admin.'}else if(state.paused&&state.userId!==state.pausedBy){els.input.placeholder='Chat is paused by admin.'}else{els.input.placeholder='Type a messageâ€¦ (Shift+Enter = newline)'}}
function updateMuteList(){const arr=Array.from(state.mutedNicks.values());document.getElementById('muteList').textContent=arr.length?`Muted: ${arr.join(', ')}`:'Muted: (none)';updateComposerDisabled()}
function updateBanList(){const arr=Array.from(state.bannedTerms.values());els.banList.textContent=arr.length?`Banned terms: ${arr.join(', ')}`:'Banned terms: (none)'}
function startDisco(ms=10000){clearTimeout(state.discoTimer);document.body.classList.add('disco');sys('âœ¨ Disco!');state.discoTimer=setTimeout(()=>{document.body.classList.remove('disco')},ms)}
function startPulse(ms=8000){document.body.classList.add('pulse');setTimeout(()=>document.body.classList.remove('pulse'),ms)}
function startShake(ms=5000){document.body.classList.add('shake');setTimeout(()=>document.body.classList.remove('shake'),ms)}
function startConfetti(ms=5000){for(let i=0;i<150;i++){const d=document.createElement('div');d.className='confetti';d.style.left=Math.random()*100+'vw';d.style.background=`hsl(${Math.random()*360},85%,60%)`;d.style.animationDuration=3+Math.random()*2+'s';d.style.animationDelay=Math.random()*1+'s';d.style.transform=`translateY(-10px) rotate(${Math.random()*360}deg)`;document.body.appendChild(d);setTimeout(()=>d.remove(),6000)}setTimeout(()=>{},ms)}
function showBlocker(){document.getElementById('blocker').style.display='';state.kicked=true;updateComposerDisabled()}
function renderAnnouncement(text,by,at){if(text){els.announce.style.display='block';els.announceText.textContent=text;els.announceBy.textContent=by?by:'admin';els.announceAt.textContent=at?new Date(at).toLocaleString():''}else{els.announce.style.display='none';els.announceText.textContent='';els.announceBy.textContent='';els.announceAt.textContent=''}}
const pinsKey=()=>`pins:${state.room}`
function loadPins(){try{state.pins=JSON.parse(localStorage.getItem(pinsKey())||'[]')}catch{state.pins=[]}renderPins()}
function savePins(){localStorage.setItem(pinsKey(),JSON.stringify(state.pins))}
function renderPins(){els.pinList.innerHTML='';if(!state.pins.length){const p=document.createElement('div');p.className='hint';p.textContent='No pins yet';els.pinList.appendChild(p);return}state.pins.forEach(addPinDOM)}
function addPinDOM(p){const d=document.createElement('div');d.className='pin';d.dataset.id=p.id;d.innerHTML=`<div class="meta"><strong>${escapeHtml(p.name)}</strong> Â· ${new Date(p.created_at).toLocaleString()}</div><div class="text">${escapeHtml(p.text)}</div>`;d.title='Doubleâ€‘click to unpin';d.addEventListener('dblclick',()=>unpin(p.id));els.pinList.appendChild(d)}
function pinMessage(m){const id=msgKey(m);if(state.pins.find(x=>x.id===id))return;if(state.pins.length>=5){alert('Pin board is full (max 5). Doubleâ€‘click a pin to remove.');return}const item={id,name:m.name||'anon',text:maskModeration(m.text),created_at:m.created_at||new Date().toISOString()};state.pins.push(item);savePins();renderPins()}
function unpin(id){state.pins=state.pins.filter(p=>p.id!==id);savePins();renderPins()}
async function loadRoomState(){const{data,error}=await supabase.from('room_state').select('paused, paused_by, paused_name, muted_nicks, announcement_text, announcement_by, announcement_at').eq('room',state.room).maybeSingle();if(!error&&data){setPaused(!!data.paused,data.paused_by||null,data.paused_name||null);state.mutedNicks=new Set((data.muted_nicks||[]).map(norm));updateMuteList();renderAnnouncement(data.announcement_text||'',data.announcement_by||'',data.announcement_at||'')}else{setPaused(false,null,null);state.mutedNicks=new Set();updateMuteList();renderAnnouncement('','','')}}
async function loadBannedTerms(){const{data,error}=await supabase.from('banned_terms').select('term');if(!error&&data){state.bannedTerms=new Set(data.map(r=>norm(r.term)))}else{state.bannedTerms=new Set()}updateBanList()}
async function loadReactionsFor(ids){if(!ids.length)return;const{data,error}=await supabase.from('message_reactions').select('message_id, emoji, user_id').eq('room',state.room).in('message_id',ids);if(error)return;data.forEach(r=>{const map=state.reactions.get(r.message_id)||{};map[r.emoji]=map[r.emoji]||new Set();map[r.emoji].add(r.user_id);state.reactions.set(r.message_id,map)});ids.forEach(renderReactions)}
async function checkBan(){const{data}=await supabase.from('banned_users').select('user_id').eq('user_id',state.userId).maybeSingle();state.banned=!!data;updateComposerDisabled()}
async function heartbeat(){const now=new Date().toISOString();await supabase.from('presence').upsert({user_id:state.userId,name:state.name||'anon',room:state.room,updated_at:now});}
async function refreshRooms(){const cutoff=new Date(Date.now()-90*1000).toISOString();const{data:all}=await supabase.from('presence').select('user_id').gt('updated_at',cutoff);els.globalOnline.textContent=`${new Set((all||[]).map(r=>r.user_id)).size} online (global)`;const{data:rooms}=await supabase.from('presence').select('room,user_id').gt('updated_at',cutoff);const counts=new Map();(rooms||[]).forEach(r=>{counts.set(r.room,(counts.get(r.room)||new Set()).add(r.user_id))});els.roomsList.innerHTML='';[...counts.entries()].sort((a,b)=>b[1].size-a[1].size).forEach(([room,set])=>{const d=document.createElement('span');d.className='roomPill';d.textContent=`#${room} Â· ${set.size}`;d.addEventListener('click',()=>joinRoom(room));els.roomsList.appendChild(d)});els.roomsUpdated.textContent=new Date().toLocaleTimeString()}
async function joinRoom(newRoom){if(state.roomChannel){await supabase.removeChannel(state.roomChannel);state.roomChannel=null}clearUI();state.kicked=false;document.getElementById('blocker').style.display='none';state.room=(newRoom||'global').toLowerCase().replace(/[^a-z0-9_-]/g,'-');localStorage.setItem('room',state.room);els.roomInput.value=state.room;document.getElementById('roomNameLabel').textContent=state.room;state.roomChannel=supabase.channel(`room:${state.room}`,{config:{presence:{key:state.userId}}});state.roomChannel.on('presence',{event:'sync'},()=>{const pres=state.roomChannel.presenceState();const users=new Set();for(const k in pres){pres[k].forEach(v=>users.add(v.userId))}document.getElementById('online').textContent=`${users.size} online`});if(PERSIST){state.roomChannel.on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`room=eq.${state.room}`},payload=>addIfNew(payload.new));state.roomChannel.on('postgres_changes',{event:'*',schema:'public',table:'room_state',filter:`room=eq.${state.room}`},payload=>{const row=payload.new||payload.old||{};setPaused(!!row.paused,row.paused_by||null,row.paused_name||null);state.mutedNicks=new Set((row.muted_nicks||[]).map(norm));updateMuteList();renderAnnouncement(row.announcement_text||'',row.announcement_by||'',row.announcement_at||'')});state.roomChannel.on('postgres_changes',{event:'INSERT',schema:'public',table:'message_reactions',filter:`room=eq.${state.room}`},({new:r})=>{const map=state.reactions.get(r.message_id)||{};map[r.emoji]=map[r.emoji]||new Set();map[r.emoji].add(r.user_id);state.reactions.set(r.message_id,map);renderReactions(r.message_id)});state.roomChannel.on('postgres_changes',{event:'DELETE',schema:'public',table:'message_reactions',filter:`room=eq.${state.room}`},({old:r})=>{const map=state.reactions.get(r.message_id)||{};if(map[r.emoji])map[r.emoji].delete(r.user_id);state.reactions.set(r.message_id,map);renderReactions(r.message_id)})}
state.roomChannel.on('broadcast',{event:'msg'},({payload})=>addIfNew(payload));state.roomChannel.on('broadcast',{event:'admin'},({payload})=>{if(payload?.type==='clear'){clearUI();sys('Chat cleared by admin')}if(payload?.type==='pause'){setPaused(true,payload.by||null,payload.name||'admin')}if(payload?.type==='unpause'){setPaused(false,null,null)}if(payload?.type==='disco'){startDisco(payload.duration||10000)}if(payload?.type==='kick'&&norm(state.name)===norm(payload.nick)){showBlocker()}if(payload?.type==='muted'){state.mutedNicks.add(norm(payload.nick));updateMuteList()}if(payload?.type==='unmuted'){state.mutedNicks.delete(norm(payload.nick));updateMuteList()}if(payload?.type==='announce'){renderAnnouncement(payload.text||'',payload.by||'admin',new Date().toISOString())}if(payload?.type==='ban'&&payload.user_id===state.userId){state.banned=true;updateComposerDisabled();alert('You have been banned by the owner.');}if(payload?.type==='unban'&&payload.user_id===state.userId){state.banned=false;updateComposerDisabled();sys('You were unbanned')}});state.roomChannel.on('broadcast',{event:'rxn'},({payload})=>{const id=payload.message_id;const map=state.reactions.get(id)||{};map[payload.emoji]=map[payload.emoji]||new Set();if(payload.op==='add')map[payload.emoji].add(payload.user_id);else map[payload.emoji].delete(payload.user_id);state.reactions.set(id,map);renderReactions(id)});state.roomChannel.on('broadcast',{event:'fx'},({payload})=>{if(payload.fx==='pulse')startPulse(payload.duration||8000);if(payload.fx==='shake')startShake(payload.duration||5000);if(payload.fx==='confetti')startConfetti(payload.duration||5000)});await state.roomChannel.subscribe(async s=>{if(s==='SUBSCRIBED'){state.roomChannel.track({userId:state.userId,name:state.name||'anon',room:state.room});await loadRecent();await loadRoomState();await loadBannedTerms();await checkBan();loadPins();renderSwatches();sys(`Joined #${state.room}`);await heartbeat();await refreshRooms();clearInterval(state.presenceTimer);state.presenceTimer=setInterval(async()=>{await heartbeat();},20000)}})}
/* ==== PART 2 â€” games, owner ban/unban, events, init ==== */
function renderSwatches(){
els.colorRow.innerHTML='';
COLORS.forEach(c=>{
  const d=document.createElement('div');
  d.className='swatch';
  d.style.background=c;
  d.dataset.c=c;
  if(state.color===c)d.classList.add('sel');
  d.addEventListener('click',()=>{state.color=c;localStorage.setItem('color',c);renderSwatches()});
  els.colorRow.appendChild(d);
});
}
function gameRPS(){
  const el=document.createElement('div');
  const out=document.createElement('div');
  const row=document.createElement('div');
  ['Rock','Paper','Scissors'].forEach((t,i)=>{
    const b=document.createElement('button');
    b.className='btn';
    b.textContent=t;
    b.addEventListener('click',()=>{
      const me=i;const ai=Math.floor(Math.random()*3);
      const m=['ðŸª¨','ðŸ“„','âœ‚ï¸'][me],a=['ðŸª¨','ðŸ“„','âœ‚ï¸'][ai];
      const w=(me===ai)?'Draw':(me===0&&ai===2||me===1&&ai===0||me===2&&ai===1)?'You win!':'You lose';
      out.textContent=`You ${m} vs ${a} â€¢ ${w}`;
    });
    row.appendChild(b);
  });
  el.appendChild(row);el.appendChild(out);
  els.game.innerHTML='';els.game.appendChild(el);
}
function gameTTT(){
  const el=document.createElement('div');el.className='ttt';
  let board=Array(9).fill('');const cells=[];
  function win(b){const L=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(const [a,c,d]of L){if(b[a]&&b[a]===b[c]&&b[a]===b[d])return b[a]}return b.every(x=>x)?'draw':null}
  function ai(){let idx=board.findIndex(x=>!x);if(idx>-1){board[idx]='O';cells[idx].textContent='O'}}
  function click(i){if(board[i]||win(board))return;board[i]='X';cells[i].textContent='X';let r=win(board);if(r){els.game.querySelectorAll('button').forEach(b=>b.disabled=true);return}ai();r=win(board);if(r){els.game.querySelectorAll('button').forEach(b=>b.disabled=true)}}
  for(let i=0;i<9;i++){const b=document.createElement('button');b.addEventListener('click',()=>click(i));cells.push(b);el.appendChild(b)}
  els.game.innerHTML='';els.game.appendChild(el);
}
function gameGuess(){
  const el=document.createElement('div');let n=Math.floor(Math.random()*100)+1;let tries=0;
  const input=document.createElement('input');input.type='number';input.placeholder='1..100';input.style.marginRight='8px';
  const btn=document.createElement('button');btn.className='btn';btn.textContent='Guess';
  const out=document.createElement('div');
  btn.addEventListener('click',()=>{const v=+input.value;if(!v)return;tries++;out.textContent=v===n?`Correct in ${tries}!`:(v<n?'Higher':'Lower')});
  el.appendChild(input);el.appendChild(btn);el.appendChild(out);
  els.game.innerHTML='';els.game.appendChild(el);
}
function gameMem(){
  const el=document.createElement('div');el.className='mem';
  const faces=['ðŸŽ','ðŸŒ','ðŸ‡','ðŸ“'];let arr=faces.concat(faces).sort(()=>Math.random()-.5);
  let picks=[];let matched=new Set();
  arr.forEach((f,i)=>{const b=document.createElement('button');b.textContent='?';b.addEventListener('click',()=>{if(matched.has(i)||picks.includes(i))return;b.textContent=f;picks.push(i);if(picks.length===2){const[a,bx]=picks;setTimeout(()=>{if(arr[a]===arr[bx]){matched.add(a);matched.add(bx)}else{el.children[a].textContent='?';el.children[bx].textContent='?'}picks=[];if(matched.size===arr.length){els.game.innerHTML='You matched all!'}},500)}});el.appendChild(b)});
  els.game.innerHTML='';els.game.appendChild(el);
}
function gameReact(){
  const box=document.createElement('div');
  box.style.width='100%';box.style.height='120px';box.style.borderRadius='8px';
  box.style.display='flex';box.style.alignItems='center';box.style.justifyContent='center';box.style.userSelect='none';
  const btn=document.createElement('button');btn.className='btn';btn.textContent='Start';
  const out=document.createElement('div');out.style.marginLeft='10px';
  let t=null,armed=false,timer=null,early=false;
  function reset(){armed=false;early=false;box.style.background='transparent';btn.disabled=false;btn.textContent='Start';out.textContent=''}
  btn.addEventListener('click',()=>{btn.disabled=true;out.textContent='Wait for greenâ€¦';box.style.background='#5b1b1b';timer=setTimeout(()=>{box.style.background='#1b5b2a';t=performance.now();armed=true;out.textContent='Click!'},800+Math.random()*2000)});
  function handle(){if(!btn.disabled)return;if(early){reset();return}if(!armed){out.textContent='Too soon!';early=true;clearTimeout(timer);setTimeout(reset,800);return}const ms=Math.round(performance.now()-t);out.textContent=`${ms} ms`;setTimeout(reset,800)}
  box.addEventListener('click',handle);btn.addEventListener('click',e=>e.stopPropagation());
  els.game.innerHTML='';const wrap=document.createElement('div');wrap.style.display='flex';wrap.style.alignItems='center';wrap.appendChild(btn);wrap.appendChild(out);els.game.appendChild(wrap);els.game.appendChild(box);
}
function loadGame(k){if(k==='rps')gameRPS();else if(k==='ttt')gameTTT();else if(k==='guess')gameGuess();else if(k==='mem')gameMem();else if(k==='react')gameReact()}
async function loadRecent(){try{if(!PERSIST)return;clearUI();const{data,error}=await supabase.from('messages').select('*').eq('room',state.room).order('created_at',{ascending:false}).limit(MAX_MSGS);if(error){console.error(error);sys('Failed to load history');return}const list=(data||[]).reverse();list.forEach(addIfNew);const ids=list.map(m=>msgKey(m));await loadReactionsFor(ids)}catch(e){console.error('loadRecent failed',e)}}
async function send(){try{const raw=els.input.value;const text=(raw||'').trim();if(!text)return;if(text.length>300){alert('Max 300 characters');return}if(state.kicked){alert('You were kicked. Refresh to rejoin.');return}if(state.banned){alert('You are banned.');return}if(state.mutedNicks.has(norm(state.name))&&!state.admin){alert('You are muted by admin.');return}if(state.paused&&state.userId!==state.pausedBy){alert(`Chat is paused by ${state.pausedName||'admin'}.`);return}if(violatesModeration(text)){alert('Message blocked by moderation.');return}const name=(els.name.value||'anon').slice(0,20);els.name.value=name;state.name=name;localStorage.setItem('nickname',name);localStorage.setItem('uid',state.userId);const msg={room:state.room,user_id:state.userId,name,text,created_at:new Date().toISOString(),color:state.color};els.input.value='';state.roomChannel?.send({type:'broadcast',event:'msg',payload:msg});addIfNew(msg);if(PERSIST){const{error}=await supabase.from('messages').insert(msg);if(error)console.error(error)}}catch(e){console.error('send failed',e)}}
async function lookupUserIdByNick(nick){
  const {data}=await supabase.from('presence').select('user_id,name,updated_at');
  const target=(data||[]).sort((a,b)=>new Date(b.updated_at)-new Date(a.updated_at)).find(r=>norm(r.name)===norm(nick));
  return target?target.user_id:null;
}
async function refreshBannedList(){
  const {data}=await supabase.from('banned_users').select('user_id,name').order('created_at',{ascending:false});
  els.bannedList.textContent=(data&&data.length)?`Banned: ${data.map(r=>r.name||r.user_id).join(', ')}`:'Banned: (none)';
}
els.banBtn.addEventListener('click',async()=>{
  if(state.role!=='owner'){alert('Owner only');return}
  const nick=norm(els.banNick.value);if(!nick)return alert('Enter a nickname');
  let uid=await lookupUserIdByNick(nick);if(!uid)return alert('User not found online.');
  const {error}=await supabase.from('banned_users').upsert({user_id:uid,name:nick});
  if(error){console.error(error);alert('Ban failed')}else{state.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'ban',user_id:uid}});await refreshBannedList();}
});
els.unbanBtn.addEventListener('click',async()=>{
  if(state.role!=='owner'){alert('Owner only');return}
  const nick=norm(els.banNick.value);if(!nick)return alert('Enter a nickname');
  let uid=await lookupUserIdByNick(nick);
  if(!uid){const {data}=await supabase.from('banned_users').select('user_id,name');const row=(data||[]).find(r=>norm(r.name)===nick);if(row)uid=row.user_id}
  if(!uid)return alert('Could not resolve user to unban');
  const {error}=await supabase.from('banned_users').delete().eq('user_id',uid);
  if(error){console.error(error);alert('Unban failed')}else{state.roomChannel?.send({type:'broadcast',event:'admin',payload:{type:'unban',user_id:uid}});await refreshBannedList();}
});
els.gameSel.addEventListener('change',e=>loadGame(e.target.value));
els.send.addEventListener('click',send);
els.input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}});
els.switchRoom.addEventListener('click',()=>joinRoom(els.roomInput.value));
setStatus('Ready');
document.getElementById('name').value=state.name;
setRole('guest');
renderSwatches();
joinRoom(state.room);
window.addEventListener('beforeunload',()=>{supabase.from('presence').delete().eq('user_id',state.userId)});
const presenceChan=supabase.channel('presence-global');
presenceChan.on('postgres_changes',{event:'*',schema:'public',table:'presence'},()=>{refreshRooms()});
presenceChan.subscribe();
setInterval(()=>{refreshRooms()},15000);
(async()=>{await refreshBannedList();})();
/* ==== END PART 2 ==== */
</script>
</body>
</html>
