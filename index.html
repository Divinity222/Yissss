<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Global Chat</title>
<style>
:root{--bg:#0f172a;--t:#e5e7eb;--mut:#94a3b8;--acc:#22d3ee;--ann:#f59e0b}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0b1025,#0f172a);font:16px system-ui,Segoe UI,Roboto,sans-serif;color:var(--t);display:flex;min-height:100vh}
.container{max-width:1320px;margin:0 auto;flex:1;display:flex;flex-direction:column;gap:12px;padding:16px}
.card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
header{display:flex;align-items:center;gap:10px}header h1{margin:0;font-size:20px}header .badge{padding:4px 8px;border-radius:999px;background:#0ea5a5;font-size:12px}
.row{display:flex;gap:10px;align-items:center}.grow{flex:1}
#room{padding:10px 14px}#room input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;color:var(--t)}#room button,.btn{padding:10px 14px;border-radius:10px;border:0;background:var(--acc);color:#012;font-weight:700;cursor:pointer}
.layout{display:grid;grid-template-columns:220px 1fr 300px 300px;gap:12px;min-height:0}@media(max-width:1320px){.layout{grid-template-columns:220px 1fr 300px}}@media(max-width:1024px){.layout{grid-template-columns:1fr}}
#rules{padding:12px}#rules h3{margin:0;font-size:14px}#rules ol{margin:6px 0 0;padding-left:18px;color:#cbd5e1;line-height:1.35}
#chat{display:flex;gap:12px;flex-direction:column;min-height:0}#messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.msg{padding:10px 12px;border-radius:12px;background:#0b1226;border:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;gap:6px;cursor:pointer}.meta{font-size:12px;color:var(--mut)}.me .meta strong{color:#a7f3d0}.text{line-height:1.4;white-space:pre-wrap;word-wrap:anywhere}.sys{text-align:center;font-size:12px;color:var(--mut)}
#composer{padding:10px;display:flex;gap:8px}#composer input[type=text]{width:180px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;color:var(--t)}#composer textarea{flex:1;min-height:44px;max-height:120px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;color:var(--t);resize:vertical}
#announce{display:none;position:sticky;top:0;margin:0 12px;padding:12px;border-radius:12px;background:linear-gradient(90deg,rgba(245,158,11,.18),rgba(245,158,11,.08));border:1px solid var(--ann);box-shadow:0 4px 20px rgba(245,158,11,.15)}#announce .label{font-weight:700;text-transform:uppercase;font-size:12px;padding:2px 8px;border-radius:999px;background:var(--ann);color:#000;display:inline-block;margin-bottom:6px}
#admin{padding:12px;display:flex;flex-direction:column;gap:10px}#admin h3{margin:0;font-size:14px}.small{font-size:12px;color:var(--mut)}#admin input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;color:var(--t)}.btn-row{display:flex;gap:8px;flex-wrap:wrap}.pill{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
#pins{padding:12px}#pinList{display:flex;flex-direction:column;gap:8px;max-height:380px;overflow:auto}.pin{padding:10px 12px;border-radius:12px;background:#0b1226;border:1px solid rgba(255,255,255,.12)}.pin .meta{font-size:12px;color:var(--mut)}
#fun{grid-column:1/-1;padding:12px;display:flex;flex-direction:column;gap:10px}#colorRow{display:flex;gap:8px;flex-wrap:wrap}.swatch{width:24px;height:24px;border-radius:999px;border:2px solid rgba(255,255,255,.25);cursor:pointer;box-shadow:inset 0 0 0 1px rgba(0,0,0,.15)}.swatch.sel{outline:2px solid #fff}
#gameSel,#difficultySel{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1226;color:var(--t)}#game{min-height:260px;height:260px;background:#0b1226;border:1px dashed rgba(255,255,255,.15);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;color:#cbd5e1}
.reactions{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}.rxn{display:inline-flex;gap:4px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);cursor:pointer;font-size:13px}.rxn.mine{outline:1px solid var(--acc)}
@keyframes partyHue{from{filter:hue-rotate(0)}to{filter:hue-rotate(360deg)}}body.disco{animation:partyHue 1s linear infinite}
@keyframes fxPulse{0%{filter:saturate(1)}50%{filter:saturate(1.6) brightness(1.15)}100%{filter:saturate(1)}}body.pulse{animation:fxPulse 1s ease-in-out infinite}
@keyframes fxShake{0%,100%{transform:translate(0,0)}25%{transform:translate(2px,-2px)}50%{transform:translate(-2px,2px)}75%{transform:translate(2px,2px)}}body.shake{animation:fxShake .1s linear infinite}
@keyframes confettiFall{to{transform:translateY(110vh) rotate(720deg)}}.confetti{position:fixed;width:6px;height:6px;top:-10px;animation:confettiFall linear forwards;z-index:9998;border-radius:2px}
.blocker{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999}.blocker-inner{max-width:520px;text-align:center;padding:24px;border-radius:16px;background:#0b1226;border:1px solid rgba(255,255,255,.12)}
#roomsCard{padding:10px}#roomsList{display:flex;gap:8px;flex-wrap:wrap}.roomPill{padding:6px 10px;border-radius:999px;background:#0b1226;border:1px solid rgba(255,255,255,.12);font-size:12px}
</style>
<link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3ctext y='14' font-size='14'%3e%F0%9F%92%AC%3c/text%3e%3c/svg%3e"/>
</head>
<body>
<div id="blocker" class="blocker"><div class="blocker-inner"><h2>You've been kicked</h2><p class="small">Refresh to rejoin.</p></div></div>
<div class="container">
<header><h1>Global Chat</h1><span class="badge" id="online">â€¦</span><span class="badge" id="globalOnline">â€¦</span><div class="grow"></div><span class="meta" id="status">Connectingâ€¦</span></header>
<div id="room" class="card"><div class="row" style="width:100%"><label class="meta" for="roomInput">Room:</label><input id="roomInput" placeholder="global"/><button id="switchRoom">Join</button></div></div>
<div id="roomsCard" class="card"><div class="row" style="justify-content:space-between"><div class="meta">Open rooms</div><div class="meta" id="roomsUpdated"></div></div><div id="roomsList"></div></div>
<div class="layout">
<aside id="rules" class="card"><h3>Rules</h3><ol><li>No offensive/unsafe topics or names</li><li>Slurs/offensive nicknames are filtered.</li><li>Abusing admin can remove access.</li><li>End drama fast or use private rooms.</li><li>Venting: rooms Vent 1â€“3 or keep &lt;10m.</li></ol></aside>
<div id="chat" class="card"><div id="announce"><div class="label">ðŸ“¢ Announcement</div><div id="announceText" class="txt"></div><div class="small">â€” <span id="announceBy"></span> <span id="announceAt"></span></div></div><div id="messages"></div><div id="composer"><input id="name" placeholder="Nickname" maxlength="20"/><textarea id="input" placeholder="Type a messageâ€¦ (Shift+Enter newline)" maxlength="300"></textarea><button id="send">Send</button></div></div>
<aside id="admin" class="card"><div class="row" style="justify-content:space-between;align-items:center"><h3>Admin</h3><span class="pill">Status: <b id="pauseState">active</b></span></div>
<div id="adminLocked"><p class="small">Enter passcode.</p><input id="pass" type="password" placeholder="Passcode"/><div class="btn-row"><button id="unlock" class="btn">Unlock</button></div></div>
<div id="adminControls" style="display:none"><p class="small">Controls for <b id="roomNameLabel">global</b></p><div class="btn-row"><button id="pauseBtn" class="btn">Pause</button><button id="unpauseBtn" class="btn">Unpause</button><button id="clearBtn" class="btn">Clear</button><button id="discoBtn" class="btn">Disco 10s</button><button id="fxPulse" class="btn">Pulse 8s</button><button id="fxShake" class="btn">Shake 5s</button><button id="fxConfetti" class="btn">Confetti</button><button id="fxEmoji" class="btn">Emoji Rain</button><button id="fxSnow" class="btn">Snow 15s</button><button id="fxFireworks" class="btn">Fireworks</button></div>
<hr style="opacity:.15"><div class="row" style="flex-direction:column;align-items:stretch;gap:8px"><input id="targetNick" placeholder="Nickname (case-insensitive)"/><div class="btn-row"><button id="kickBtn" class="btn">Kick</button><button id="muteBtn" class="btn">Mute</button><button id="unmuteBtn" class="btn">Unmute</button></div><div id="muteList" class="small"></div></div>
<hr style="opacity:.15"><div class="row" style="flex-direction:column;align-items:stretch;gap:8px"><input id="announceInput" placeholder="Announcement text"/><div class="btn-row"><button id="setAnnBtn" class="btn">Set</button><button id="clrAnnBtn" class="btn">Clear</button></div></div>
<hr style="opacity:.15"><div class="row" style="flex-direction:column;align-items:stretch;gap:8px"><input id="banTerm" placeholder="Add banned term"/><div class="btn-row"><button id="addBan" class="btn">Add term</button><button id="delBan" class="btn">Remove term</button></div><div id="banList" class="small"></div></div>
<hr style="opacity:.15"><div id="ownerOnly" style="display:none" class="row"><div style="width:100%"><div class="small">Owner tools</div><div class="row" style="flex-direction:column;align-items:stretch;gap:8px"><input id="banNick" placeholder="Ban by nickname (online)"/><div class="btn-row"><button id="banBtn" class="btn">Ban</button><button id="unbanBtn" class="btn">Unban</button></div><div id="bannedList" class="small"></div></div></div></div>
</div></aside>
<aside id="pins" class="card"><h3 style="margin:8px 12px">Pinned (max 5)</h3><div class="small" style="margin:0 12px">Doubleâ€‘click a message to pin. Doubleâ€‘click a pin to unpin.</div><div id="pinList"></div></aside>
<aside id="fun" class="card"><h3 style="margin:0">Fun & Style</h3><div id="colorRow" class="row"></div><div class="row"><select id="gameSel"><option value="rps">Rock â€¢ Paper â€¢ Scissors</option><option value="ttt">Ticâ€‘Tacâ€‘Toe</option><option value="guess">Number Guess</option><option value="mem">Memory Match</option><option value="react">Reaction Test</option><option value="snake">Snake</option></select><select id="difficultySel"><option value="easy">Easy</option><option value="normal" selected>Normal</option><option value="hard">Hard</option></select></div><div id="game">Pick a game</div></aside>
</div>
<footer class="small" style="text-align:center;color:#94a3b8">Supabase realtime chat â€¢ Be kind âœ¨</footer>
<script type="module">
import {createClient} from 'https://esm.sh/@supabase/supabase-js@2'
const SUPABASE_URL='https://prpjfrqfbbsxqhspqheo.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBycGpmcnFmYmJzeHFoc3BxaGVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNjgwMDksImV4cCI6MjA3Mzc0NDAwOX0.XEUz5g-tzW4UAsKLk62FJratwaLYAL-1noBTu0EwTkY';
const PERSIST=true,MAX_MSGS=15,ADMIN_PASS='DivinePermissions',OWNER_PASS='ServerHostPanel';
const REACTIONS=['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ˜¡'];
const COLORS=['#ffffff','#cbd5e1','#facc15','#fb923c','#22d3ee','#38bdf8','#3b82f8','#8b5cf6','#a78bfa','#ec4899','#f472b6','#f43f5e','#10b981','#a3e635','#f59e0b'];
const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const ids=['status','input','send','messages','name','online','globalOnline','roomsList','roomsUpdated','roomInput','switchRoom','adminLocked','adminControls','pass','unlock','pauseBtn','unpauseBtn','clearBtn','discoBtn','pauseState','roomNameLabel','targetNick','kickBtn','muteBtn','unmuteBtn','blocker','announce','announceText','announceBy','announceAt','announceInput','setAnnBtn','clrAnnBtn','pinList','banTerm','addBan','delBan','banList','ownerOnly','banNick','banBtn','unbanBtn','bannedList','colorRow','gameSel','difficultySel','game','fxPulse','fxShake','fxConfetti','fxEmoji','fxSnow','fxFireworks'];
const els=Object.fromEntries(ids.map(id=>[id,document.getElementById(id)]));
let state={room:localStorage.getItem('room')||'global',name:localStorage.getItem('nickname')||'',userId:localStorage.getItem('uid')||crypto.randomUUID(),role:'guest',roomChannel:null,admin:false,paused:false,pausedBy:null,pausedName:null,discoTimer:null,mutedNicks:new Set(),kicked:false,pins:[],reactions:new Map(),bannedTerms:new Set(),banned:false,color:localStorage.getItem('color')||COLORS[0],presenceTimer:null,currentGame:'rps'};
const norm=s=>(s||'').trim().toLowerCase();
const msgKey=m=>`${m.user_id}|${m.created_at}|${m.text}`;
function setStatus(t){els.status.textContent=t}
function sys(t){const d=document.createElement('div');d.className='sys';d.textContent=t;els.messages.appendChild(d);els.messages.scrollTop=els.messages.scrollHeight}
function esc(s){return(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}
function collapse(t){let o='',p='',c=0;for(const ch of t){if(ch===p){c++;if(c<=2)o+=ch}else{p=ch;c=1;o+=ch}}return o}
function normMod(s){if(!s)return'';let t=s.toLowerCase();t=t.replace(/[@]/g,'a').replace(/[0]/g,'o').replace(/[1l!]/g,'i').replace(/[3]/g,'e').replace(/[4]/g,'a').replace(/[5$]/g,'s').replace(/[7]/g,'t');t=t.replace(/[^a-z0-9]+/g,'');return collapse(t)}
function violates(text){const n=normMod(text);for(const term of state.bannedTerms){if(n.includes(term))return true}return false}
function renderReactions(id){const w=els.messages.querySelector(`.msg[data-id="${CSS.escape(id)}"]`);if(!w)return;const bar=w.querySelector('.reactions');const map=state.reactions.get(id)||{};[...bar.children].forEach(n=>{const e=n.dataset.emoji,s=map[e]||new Set();n.textContent=`${e} ${s.size||''}`.trim();s.has(state.userId)?n.classList.add('mine'):n.classList.remove('mine')})}
async function toggleReaction(messageId,emoji){const map=state.reactions.get(messageId)||{};map[emoji]=map[emoji]||new Set();const has=map[emoji].has(state.userId);if(has){map[emoji].delete(state.userId);state.reactions.set(messageId,map);renderReactions(messageId);await supabase.from('message_reactions').delete().match({room:state.room,message_id:messageId,emoji,user_id:state.userId});state.roomChannel?.send({type:'broadcast',event:'rxn',payload:{op:'del',message_id:messageId,emoji,user_id:state.userId}})}else{map[emoji].add(state.userId);state.reactions.set(messageId,map);renderReactions(messageId);await supabase.from('message_reactions').insert({room:state.room,message_id:messageId,emoji,user_id:state.userId});state.roomChannel?.send({type:'broadcast',event:'rxn',payload:{op:'add',message_id:messageId,emoji,user_id:state.userId}})}}
function renderMsg(m){const wrap=document.createElement('div');const mine=m.user_id===state.userId;const id=msgKey(m);wrap.className='msg'+(mine?' me':'');wrap.dataset.id=id;const meta=document.createElement('div');meta.className='meta';const when=new Date(m.created_at||Date.now());meta.innerHTML=`<strong>${esc(m.name||'anon')}</strong> Â· ${when.toLocaleString()}${mine?' Â· you':''}`;const text=document.createElement('div');text.className='text';text.style.color=m.color||'';text.textContent=violates(m.text)?'ðŸš« [filtered]':m.text;const rxn=document.createElement('div');rxn.className='reactions';REACTIONS.forEach(e=>{const b=document.createElement('span');b.className='rxn';b.dataset.emoji=e;b.textContent=e;b.onclick=()=>toggleReaction(id,e);rxn.appendChild(b)});wrap.append(meta,text,rxn);wrap.title='Doubleâ€‘click to pin';wrap.ondblclick=()=>pinMessage(m);els.messages.appendChild(wrap);renderReactions(id)}
function trimUI(){const nodes=[...els.messages.querySelectorAll('.msg')];const extra=nodes.length-MAX_MSGS;for(let i=0;i<extra;i++)nodes[i].remove();els.messages.scrollTop=els.messages.scrollHeight}
function clearUI(){els.messages.innerHTML='';rendered.clear()}
function addIfNew(m){const k=msgKey(m);if(rendered.has(k))return;rendered.add(k);renderMsg(m);trimUI()}
function setRole(r){state.role=r;state.admin=r==='admin'||r==='owner';els.adminLocked.style.display=state.admin?'none':'';els.adminControls.style.display=state.admin?'block':'none';els.ownerOnly.style.display=r==='owner'?'block':'none'}
function setPaused(p,byId=null,byName=null){state.paused=!!p;state.pausedBy=byId;state.pausedName=byName;els.pauseState.textContent=state.paused?(state.pausedName?`paused by ${state.pausedName}`:'paused'):'active';updateComposerDisabled()}
function updateComposerDisabled(){const blocked=(state.paused&&state.userId!==state.pausedBy)||state.kicked||state.mutedNicks.has(norm(state.name))||state.banned;els.input.disabled=blocked;els.send.disabled=blocked;els.input.placeholder=state.kicked?'You were kicked. Refresh.':state.banned?'You are banned.':state.mutedNicks.has(norm(state.name))?'You are muted by admin.':state.paused&&state.userId!==state.pausedBy?'Chat paused by admin.':'Type a messageâ€¦ (Shift+Enter)'}
function updateMuteList(){const a=[...state.mutedNicks.values()];document.getElementById('muteList').textContent=a.length?`Muted: ${a.join(', ')}`:'Muted: (none)'}
function updateBanList(){const a=[...state.bannedTerms.values()];els.banList.textContent=a.length?`Banned terms: ${a.join(', ')}`:'Banned terms: (none)'}
function startDisco(ms=10000){clearTimeout(state.discoTimer);document.body.classList.add('disco');sys('âœ¨ Disco!');state.discoTimer=setTimeout(()=>document.body.classList.remove('disco'),ms)}
function startPulse(ms=8000){document.body.classList.add('pulse');setTimeout(()=>document.body.classList.remove('pulse'),ms)}
function startShake(ms=5000){document.body.classList.add('shake');setTimeout(()=>document.body.classList.remove('shake'),ms)}
function startConfetti(ms=5000){for(let i=0;i<150;i++){const d=document.createElement('div');d.className='confetti';d.style.left=Math.random()*100+'vw';d.style.background=`hsl(${Math.random()*360},85%,60%)`;d.style.animationDuration=3+Math.random()*2+'s';d.style.animationDelay=Math.random()*1+'s';document.body.appendChild(d);setTimeout(()=>d.remove(),6000)}}
function showBlocker(){els.blocker.style.display='flex';state.kicked=true;updateComposerDisabled()}
function renderAnnouncement(text,by,at){if(text){els.announce.style.display='block';els.announceText.textContent=text;els.announceBy.textContent=by||'admin';els.announceAt.textContent=at?new Date(at).toLocaleString():''}else{els.announce.style.display='none';els.announceText.textContent='';els.announceBy.textContent='';els.announceAt.textContent=''}}
const pinsKey=()=>`pins:${state.room}`;
function loadPins(){try{state.pins=JSON.parse(localStorage.getItem(pinsKey())||'[]')}catch{state.pins=[]}renderPins()}
function savePins(){localStorage.setItem(pinsKey(),JSON.stringify(state.pins))}
function renderPins(){els.pinList.innerHTML='';if(!state.pins.length){const p=document.createElement('div');p.className='small';p.textContent='No pins yet';els.pinList.appendChild(p);return}state.pins.forEach(addPinDOM)}
function addPinDOM(p){const d=document.createElement('div');d.className='pin';d.dataset.id=p.id;d.innerHTML=`<div class="meta"><strong>${esc(p.name)}</strong> Â· ${new Date(p.created_at).toLocaleString()}</div><div class="text">${esc(p.text)}</div>`;d.title='Doubleâ€‘click to unpin';d.ondblclick=()=>unpin(p.id);els.pinList.appendChild(d)}
function pinMessage(m){const id=msgKey(m);if(state.pins.find(x=>x.id===id))return;if(state.pins.length>=5){alert('Pin board is full (max 5).');return}const item={id,name:m.name||'anon',text:violates(m.text)?'ðŸš« [filtered]':m.text,created_at:m.created_at||new Date().toISOString()};state.pins.push(item);savePins();renderPins()}
function unpin(id){state.pins=state.pins.filter(p=>p.id!==id);savePins();renderPins()}
function roleFromPass(p){const v=(p||'').trim();if(!v)return null;if(v===OWNER_PASS||v.toLowerCase()===OWNER_PASS.toLowerCase())return'owner';if(v===ADMIN_PASS||v.toLowerCase()===ADMIN_PASS.toLowerCase())return'admin';return null}
els.unlock.onclick=()=>{const r=roleFromPass(els.pass.value);if(r){setRole(r);els.pass.value=''}else alert('Wrong passcode')};
els.pass.onkeydown=e=>{if(e.key==='Enter')els.unlock.onclick()};
function renderSwatches(){els.colorRow.innerHTML='';COLORS.forEach(c=>{const d=document.createElement('div');d.className='swatch';d.style.background=c;if(state.color===c)d.classList.add('sel');d.title=c;d.onclick=()=>{state.color=c;localStorage.setItem('color',c);renderSwatches()};els.colorRow.appendChild(d)})}
async function loadReactionsFor(ids){if(!ids.length)return;const{data,error}=await supabase.from('message_reactions').select('message_id,emoji,user_id').eq('room',state.room).in('message_id',ids);if(error)return;data.forEach(r=>{const m=state.reactions.get(r.message_id)||{};m[r.emoji]=m[r.emoji]||new Set();m[r.emoji].add(r.user_id);state.reactions.set(r.message_id,m)});ids.forEach(renderReactions)}
async function loadRoomState(){const{data,error}=await supabase.from('room_state').select('paused,paused_by,paused_name,muted_nicks,announcement_text,announcement_by,announcement_at').eq('room',state.room).maybeSingle();if(!error&&data){setPaused(!!data.paused,data.paused_by||null,data.paused_name||null);state.mutedNicks=new Set((data.muted_nicks||[]).map(norm));updateMuteList();renderAnnouncement(data.announcement_text||'',data.announcement_by||'',data.announcement_at||'')}else{setPaused(false,null,null);state.mutedNicks=new Set();updateMuteList();renderAnnouncement('','','')}}
async function loadRecent(){if(!PERSIST)return;clearUI();const{data,error}=await supabase.from('messages').select('*').eq('room',state.room).order('created_at',{ascending:false}).limit(MAX_MSGS);if(error){sys('Failed to load history');return}const list=(data||[]).reverse();list.forEach(addIfNew);await loadReactionsFor(list.map(m=>msgKey(m)))}
async function checkBan(){const{data}=await supabase.from('banned_users').select('user_id').eq('user_id',state.userId).maybeSingle();state.banned=!!data;updateComposerDisabled()}
async function send(){const raw=els.input.value,text=(raw||'').trim();if(!text)return;if(text.length>300)return alert('Max 300');if(state.kicked)return alert('You were kicked. Refresh to rejoin.');if(state.banned)return alert('You are banned.');if(state.mutedNicks.has(norm(state.name))&&!state.admin)return alert('You are muted.');if(state.paused&&state.userId!==state.pausedBy)return alert(`Paused by ${state.pausedName||'admin'}`);if(violates(text))return alert('Message blocked by moderation.');const name=(els.name.value||'anon').slice(0,20);els.name.value=name;state.name=name;localStorage.setItem('nickname',name);const msg={room:state.room,user_id:state.userId,name,text,created_at:new Date().toISOString(),color:state.color};els.input.value='';state.roomChannel?.send({type:'broadcast',event:'msg',payload:msg});addIfNew(msg);if(PERSIST){const{error}=await supabase.from('messages').insert(msg);if(error)console.error(error)}}
async function heartbeat(){const now=new Date().toISOString();await supabase.from('presence').upsert({user_id:state.userId,name:state.name||'anon',room:state.room,updated_at:now})}
async function refreshRooms(){const cutoff=new Date(Date.now()-90*1000).toISOString();const{data:all}=await supabase.from('presence').select('user_id').gt('updated_at',cutoff);els.globalOnline.textContent=`${new Set((all||[]).map(r=>r.user_id)).size} online (global)`;const{data:rows}=await supabase.from('presence').select('room,user_id').gt('updated_at',cutoff);const map=new Map();(rows||[]).forEach(r=>{if(!map.has(r.room))map.set(r.room,new Set());map.get(r.room).add(r.user_id)});els.roomsList.innerHTML='';[...map.entries()].sort((a,b)=>b[1].size-a[1].size).forEach(([room,set])=>{const d=document.createElement('span');d.className='roomPill';d.textContent=`#${room} Â· ${set.size}`;d.onclick=()=>joinRoom(room);els.roomsList.appendChild(d)});els.roomsUpdated.textContent=new Date().toLocaleTimeString()}
async function joinRoom(newRoom){if(state.roomChannel){await supabase.removeChannel(state.roomChannel);state.roomChannel=null}clearUI();state.kicked=false;els.blocker.style.display='none';state.room=(newRoom||'global').toLowerCase().replace(/[^a-z0-9_-]/g,'-');localStorage.setItem('room',state.room);els.roomInput.value=state.room;els.roomNameLabel.textContent=state.room;const ch=supabase.channel(`room:${state.room}`,{config:{presence:{key:state.userId}}});state.roomChannel=ch;ch.on('presence',{event:'sync'},()=>{const ps=ch.presenceState(),u=new Set();for(const k in ps){ps[k].forEach(v=>u.add(v.userId))}els.online.textContent=`${u.size} online`});
if(PERSIST){ch.on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`room=eq.${state.room}`},p=>addIfNew(p.new));ch.on('postgres_changes',{event:'*',schema:'public',table:'room_state',filter:`room=eq.${state.room}`},p=>{const r=p.new||p.old||{};setPaused(!!r.paused,r.paused_by||null,r.paused_name||null);state.mutedNicks=new Set((r.muted_nicks||[]).map(norm));updateMuteList();renderAnnouncement(r.announcement_text||'',r.announcement_by||'',r.announcement_at||'')});ch.on('postgres_changes',{event:'INSERT',schema:'public',table:'message_reactions',filter:`room=eq.${state.room}`},({new:r})=>{const m=state.reactions.get(r.message_id)||{};m[r.emoji]=m[r.emoji]||new Set();m[r.emoji].add(r.user_id);state.reactions.set(r.message_id,m);renderReactions(r.message_id)});ch.on('postgres_changes',{event:'DELETE',schema:'public',table:'message_reactions',filter:`room=eq.${state.room}`},({old:r})=>{const m=state.reactions.get(r.message_id)||{};if(m[r.emoji])m[r.emoji].delete(r.user_id);state.reactions.set(r.message_id,m);renderReactions(r.message_id)})}
ch.on('broadcast',{event:'msg'},e=>addIfNew(e.payload));
ch.on('broadcast',{event:'admin'},e=>{const p=e.payload||{};if(p.type==='clear'){clearUI();sys('Chat cleared by admin')}if(p.type==='pause'){setPaused(true,p.by||null,p.name||'admin')}if(p.type==='unpause'){setPaused(false,null,null)}if(p.type==='disco'){startDisco(p.duration||10000)}if(p.type==='kick'&&norm(state.name)===norm(p.nick)){els.blocker.style.display='flex';state.kicked=true;updateComposerDisabled()}if(p.type==='muted'){state.mutedNicks.add(norm(p.nick));updateMuteList()}if(p.type==='unmuted'){state.mutedNicks.delete(norm(p.nick));updateMuteList()}if(p.type==='announce'){renderAnnouncement(p.text||'',p.by||'admin',new Date().toISOString())}if(p.type==='ban'&&p.user_id===state.userId){state.banned=true;updateComposerDisabled();alert('You have been banned by the owner.')}if(p.type==='unban'&&p.user_id===state.userId){state.banned=false;updateComposerDisabled();sys('You were unbanned')}});
ch.on('broadcast',{event:'rxn'},e=>{const p=e.payload||{},id=p.message_id;const m=state.reactions.get(id)||{};m[p.emoji]=m[p.emoji]||new Set();p.op==='add'?m[p.emoji].add(p.user_id):m[p.emoji].delete(p.user_id);state.reactions.set(id,m);renderReactions(id)});
ch.on('broadcast',{event:'fx'},e=>{const p=e.payload||{},d=p.duration||5000;switch(p.fx){case 'pulse':startPulse(d);break;case 'shake':startShake(d);break;case 'confetti':startConfetti(d);break;case 'emoji':startEmojiRain?startEmojiRain(d):startConfetti(d);break;case 'snow':startSnow?startSnow(d):startConfetti(d);break;case 'fireworks':startFireworks?startFireworks(d):startConfetti(d);break}});
await ch.subscribe(async s=>{if(s==='SUBSCRIBED'){ch.track({userId:state.userId,name:state.name||'anon',room:state.room});await loadRecent();await loadRoomState();await loadBannedTerms();await checkBan();loadPins();renderSwatches();sys(`Joined #${state.room}`);await heartbeat();await refreshRooms();clearInterval(state.presenceTimer);state.presenceTimer=setInterval(()=>heartbeat(),20000)}})}
els.send.onclick=send;els.input.onkeydown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}};els.switchRoom.onclick=()=>joinRoom(els.roomInput.value);els.roomInput.onkeydown=e=>{if(e.key==='Enter')joinRoom(els.roomInput.value)};els.name.onchange=()=>{const n=(els.name.value||'anon').slice(0,20);els.name.value=n;state.name=n;localStorage.setItem('nickname',n);updateComposerDisabled();heartbeat()};
setStatus('Ready');els.name.value=state.name;setRole('guest');renderSwatches();joinRoom(state.room);
window.addEventListener('beforeunload',()=>{supabase.from('presence').delete().eq('user_id',state.userId)});
const presenceChan=supabase.channel('presence-global');presenceChan.on('postgres_changes',{event:'*',schema:'public',table:'presence'},()=>refreshRooms());presenceChan.subscribe();setInterval(()=>refreshRooms(),15000);
function ensureFxStyle(){if(document.getElementById('fx-style'))return;const st=document.createElement('style');st.id='fx-style';st.textContent=`.fx-spark{position:absolute;width:6px;height:6px;border-radius:50%;transform:translate(0,0);opacity:1;animation:fxSpark .75s ease-out forwards}@keyframes fxSpark{to{transform:translate(var(--dx),var(--dy));opacity:0}}`;document.head.appendChild(st)}
function startEmojiRain(ms=10000){const emos=['âœ¨','ðŸ’¬','ðŸŒŸ','ðŸ”¥','ðŸ’–','ðŸŽ‰'];for(let i=0;i<120;i++){const d=document.createElement('div');d.className='confetti';d.textContent=emos[i%emos.length];d.style.width='auto';d.style.height='auto';d.style.fontSize=(14+Math.random()*14)+'px';d.style.left=(Math.random()*100)+'vw';d.style.background='transparent';d.style.animationDuration=(3.5+Math.random()*2.5)+'s';d.style.animationDelay=(Math.random()*0.8)+'s';document.body.appendChild(d);setTimeout(()=>d.remove(),8000)}setTimeout(()=>{},ms)}
function startSnow(ms=15000){for(let i=0;i<140;i++){const d=document.createElement('div');d.className='confetti';d.textContent='â„ï¸';d.style.width='auto';d.style.height='auto';d.style.fontSize=(12+Math.random()*12)+'px';d.style.left=(Math.random()*100)+'vw';d.style.opacity=0.9;d.style.background='transparent';d.style.animationDuration=(4.5+Math.random()*3.5)+'s';d.style.animationDelay=(Math.random()*1.2)+'s';document.body.appendChild(d);setTimeout(()=>d.remove(),10000)}setTimeout(()=>{},ms)}
function startFireworks(ms=7000){ensureFxStyle();const root=document.createElement('div');root.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:9998';document.body.appendChild(root);let gone=false;function burst(){if(gone)return;const b=document.createElement('div');b.style.cssText='position:absolute;left:0;top:0';const x=Math.random()*100,y=10+Math.random()*60;b.style.left=x+'vw';b.style.top=y+'vh';for(let i=0;i<34;i++){const s=document.createElement('span');s.className='fx-spark';const ang=Math.random()*Math.PI*2,r=70+Math.random()*60;s.style.setProperty('--dx',(Math.cos(ang)*r)+'px');s.style.setProperty('--dy',(Math.sin(ang)*r)+'px');s.style.background=`hsl(${Math.random()*360},90%,65%)`;b.appendChild(s)}root.appendChild(b);setTimeout(()=>b.remove(),900)}const t=setInterval(burst,450);setTimeout(()=>{gone=true;clearInterval(t);root.remove()},ms)}
els.fxEmoji?.addEventListener('click',()=>{if(!state.admin)return;startEmojiRain(10000);state.roomChannel?.send({type:'broadcast',event:'fx',payload:{fx:'emoji',duration:10000}})});
els.fxSnow?.addEventListener('click',()=>{if(!state.admin)return;startSnow(15000);state.roomChannel?.send({type:'broadcast',event:'fx',payload:{fx:'snow',duration:15000}})});
els.fxFireworks?.addEventListener('click',()=>{if(!state.admin)return;startFireworks(7000);state.roomChannel?.send({type:'broadcast',event:'fx',payload:{fx:'fireworks',duration:7000}})});
function setGameContent(node,cleanup){if(els.game.currentCleanup){try{els.game.currentCleanup()}catch{}els.game.currentCleanup=null}els.game.innerHTML='';els.game.appendChild(node);els.game.currentCleanup=cleanup||null}
function diff(){const v=(els.difficultySel?.value)||'normal';if(v==='easy')return{snakeSpeed:130,snakeSize:14,guessMax:50,memPairs:4};if(v==='hard')return{snakeSpeed:70,snakeSize:12,guessMax:500,memPairs:8};return{snakeSpeed:100,snakeSize:12,guessMax:100,memPairs:6}}
function gameRPS(){const el=document.createElement('div'),out=document.createElement('div'),row=document.createElement('div');['Rock','Paper','Scissors'].forEach((t,i)=>{const b=document.createElement('button');b.className='btn';b.textContent=t;b.onclick=()=>{const me=i,ai=Math.floor(Math.random()*3);const m=['ðŸª¨','ðŸ“„','âœ‚ï¸'][me],a=['ðŸª¨','ðŸ“„','âœ‚ï¸'][ai];const w=me===ai?'Draw':(me===0&&ai===2||me===1&&ai===0||me===2&&ai===1)?'You win!':'You lose';out.textContent=`You ${m} vs ${a} â€¢ ${w}`};row.appendChild(b)});el.append(row,out);setGameContent(el)}
function gameTTT(){const el=document.createElement('div');el.className='ttt';let b=Array(9).fill(''),cells=[];const L=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];const win=bb=>{for(const[a,c,d]of L){if(bb[a]&&bb[a]===bb[c]&&bb[a]===bb[d])return bb[a]}return bb.every(x=>x)?'draw':null};const ai=()=>{let i=b.findIndex(x=>!x);if(i>-1){b[i]='O';cells[i].textContent='O'}};const click=i=>{if(b[i]||win(b))return;b[i]='X';cells[i].textContent='X';let r=win(b);if(r){el.querySelectorAll('button').forEach(x=>x.disabled=true);return}ai();r=win(b);if(r)el.querySelectorAll('button').forEach(x=>x.disabled=true)};for(let i=0;i<9;i++){const bt=document.createElement('button');bt.onclick=()=>click(i);cells.push(bt);el.appendChild(bt)}setGameContent(el)}
function gameGuess(){const cfg=diff(),el=document.createElement('div'),inp=document.createElement('input'),btn=document.createElement('button'),out=document.createElement('div');let n=Math.floor(Math.random()*cfg.guessMax)+1,tries=0;inp.type='number';inp.placeholder=`1..${cfg.guessMax}`;inp.style.marginRight='8px';btn.className='btn';btn.textContent='Guess';btn.onclick=()=>{const v=+inp.value;if(!v)return;tries++;out.textContent=v===n?`Correct in ${tries}!`:(v<n?'Higher':'Lower')};el.append(inp,btn,out);setGameContent(el)}
function gameMem(){const cfg=diff(),el=document.createElement('div');el.className='mem';const pool=['ðŸŽ','ðŸŒ','ðŸ‡','ðŸ“','ðŸ‘','ðŸ','ðŸ¥','ðŸ¥•','ðŸŒ½','ðŸ†','ðŸ¥¦','ðŸ¥‘'];const faces=pool.slice(0,cfg.memPairs);let arr=faces.concat(faces).sort(()=>Math.random()-.5),picks=[],matched=new Set();arr.forEach((f,i)=>{const b=document.createElement('button');b.textContent='?';b.onclick=()=>{if(matched.has(i)||picks.includes(i))return;b.textContent=f;picks.push(i);if(picks.length===2){const[a,c]=picks;setTimeout(()=>{if(arr[a]===arr[c]){matched.add(a);matched.add(c)}else{el.children[a].textContent='?';el.children[c].textContent='?'}picks=[];if(matched.size===arr.length)els.game.innerHTML='You matched all!'},400)}};el.appendChild(b)});setGameContent(el)}
function gameReact(){const box=document.createElement('div');box.style.cssText='width:100%;height:120px;border-radius:8px;display:flex;align-items:center;justify-content:center;user-select:none';const btn=document.createElement('button');btn.className='btn';btn.textContent='Start';const out=document.createElement('div');out.style.marginLeft='10px';let t=null,armed=false,timer=null,early=false;const reset=()=>{armed=false;early=false;box.style.background='transparent';btn.disabled=false;btn.textContent='Start';out.textContent=''};btn.onclick=()=>{btn.disabled=true;out.textContent='Wait for greenâ€¦';box.style.background='#5b1b1b';timer=setTimeout(()=>{box.style.background='#1b5b2a';t=performance.now();armed=true;out.textContent='Click!'},800+Math.random()*2000)};const handle=()=>{if(!btn.disabled)return;if(early){reset();return}if(!armed){out.textContent='Too soon!';early=true;clearTimeout(timer);setTimeout(reset,800);return}out.textContent=`${Math.round(performance.now()-t)} ms`;setTimeout(reset,800)};box.onclick=handle;btn.addEventListener('click',e=>e.stopPropagation());const wrap=document.createElement('div');wrap.style.display='flex';wrap.style.alignItems='center';wrap.append(btn,out);const root=document.createElement('div');root.append(wrap,box);setGameContent(root)}
function gameSnake(){const cfg=diff(),wrap=document.createElement('div');wrap.style.cssText='width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center';const canvas=document.createElement('canvas');const H=240,SIZE=cfg.snakeSize,W=Math.min(els.game.clientWidth-20,820);canvas.width=Math.floor(W/SIZE)*SIZE;canvas.height=Math.floor(H/SIZE)*SIZE;canvas.style.cssText='background:#111a2e;border-radius:10px;border:1px solid rgba(255,255,255,.2)';const hint=document.createElement('div');hint.className='hint';hint.style.marginTop='8px';hint.textContent='Arrows/WASD â€¢ Space to restart';wrap.append(canvas,hint);const ctx=canvas.getContext('2d');let dir={x:1,y:0},nextDir={x:1,y:0},snake=[{x:4,y:4},{x:3,y:4},{x:2,y:4}],food=spawn(),timer=null,over=false;function spawn(){const cx=canvas.width/SIZE,cy=canvas.height/SIZE;let p;do{p={x:Math.floor(Math.random()*cx),y:Math.floor(Math.random()*cy)}}while(snake.some(s=>s.x===p.x&&s.y===p.y));return p}function cell(x,y,c){ctx.fillStyle=c;ctx.fillRect(x*SIZE,y*SIZE,SIZE-1,SIZE-1)}function render(){ctx.clearRect(0,0,canvas.width,canvas.height);cell(food.x,food.y,'#f59e0b');snake.forEach((s,i)=>cell(s.x,s.y,i?'#22d3ee':'#34d399'))}function tick(){dir=nextDir;const head={x:snake[0].x+dir.x,y:snake[0].y+dir.y},cx=canvas.width/SIZE,cy=canvas.height/SIZE;if(head.x<0||head.y<0||head.x>=cx||head.y>=cy||snake.some(s=>s.x===head.x&&s.y===head.y)){gameOver();return}snake.unshift(head);if(head.x===food.x&&head.y===food.y){food=spawn()}else snake.pop();render()}function gameOver(){over=true;clearInterval(timer);ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#fff';ctx.font='bold 20px system-ui,sans-serif';ctx.fillText('Game Over â€” Space',16,28)}function onKey(e){const k=e.key.toLowerCase();if(k==='arrowup'||k==='w'){if(dir.y!==1)nextDir={x:0,y:-1}}else if(k==='arrowdown'||k==='s'){if(dir.y!==-1)nextDir={x:0,y:1}}else if(k==='arrowleft'||k==='a'){if(dir.x!==1)nextDir={x:-1,y:0}}else if(k==='arrowright'||k==='d'){if(dir.x!==-1)nextDir={x:1,y:0}}else if(k===' '&&over){over=false;dir={x:1,y:0};nextDir=dir;snake=[{x:4,y:4},{x:3,y:4},{x:2,y:4}];food=spawn();clearInterval(timer);timer=setInterval(tick,cfg.snakeSpeed);render()}}window.addEventListener('keydown',onKey);timer=setInterval(tick,cfg.snakeSpeed);render();const cleanup=()=>{window.removeEventListener('keydown',onKey);clearInterval(timer)};setGameContent(wrap,cleanup)}
function loadGame(k){try{state.currentGame=k}catch{}if(k==='rps')gameRPS();else if(k==='ttt')gameTTT();else if(k==='guess')gameGuess();else if(k==='mem')gameMem();else if(k==='react')gameReact();else if(k==='snake')gameSnake()}
els.gameSel.onchange=e=>loadGame(e.target.value);
els.difficultySel.onchange=()=>loadGame(state.currentGame||els.gameSel.value);
try{loadGame(els.gameSel.value)}catch{}



